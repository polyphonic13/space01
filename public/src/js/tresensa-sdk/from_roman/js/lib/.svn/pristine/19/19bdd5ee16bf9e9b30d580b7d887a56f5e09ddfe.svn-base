/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0020=function(){TGS.Adapters.A0020.superclass.constructor.call(this),this._mLoggedIn=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1,this._mUseUserInfoInSLB=!0},TGS.Adapters.A0020.prototype={supportsMicrotransactions:function(){return!1},autoLogin:function(){return!1},supportsLogout:function(){return!1},loginIcon:function(){return TGS._IMAGES_LOCATION+"kik_login.png"},supportsChallenges:function(){return!0},challengeIcon:function(){return TGS._IMAGES_LOCATION+"kik.png"},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+(a*this.costFactor()/100-.01).toFixed(2)},formattedPriceForItem:function(){return"$"+(aPrice*this.costFactor()/100-.01).toFixed(2)},gameWasLaunched:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Kik gameWasLaunched"),window.cards&&cards.browser&&window.TGE&&TGE.Game.GetInstance()&&(cards.browser.on("background",this.onBackground.bind(this)),cards.browser.on("foreground",this.onForeground.bind(this)),TGE.Button.DefaultVerticalPressOffset=4)},onBackground:function(){if("undefined"!=typeof window.TGE&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();TGS.Debug.Log(TGS.Debug.LOG_INFO,"pausing the game and halting update loop"),TGE.Game.GetInstance().PauseGame(!0),a._mRAFID?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"cancelling requestAnimationFrame..."),cancelAnimationFrame(a._mRAFID),a._mRAFID=null):TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already null?"),TGS.Debug.Log(TGS.Debug.LOG_INFO,"disabling updates..."),a._mUpdatingEnabled=!1}},onForeground:function(){if("undefined"!=typeof window.TGE&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();null===a._mRAFID?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"restarting requestAnimationFrame..."),a._mRAFID="undefined"!=typeof a.Update?requestAnimationFrame(a.Update.bind(a)):requestAnimationFrame(a._update.bind(a))):TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already active?"),TGS.Debug.Log(TGS.Debug.LOG_INFO,"turning updating back on with a 30 frame delay"),a._mUpdatingEnabled=!0,a._mUpdateSkips=30}},initialize:function(){navigator.onLine===!1&&(TGS.Debug.Log(TGS.Debug.LOG_WARNING,"navigator.onLine is false - TGS going into OFFLINE mode"),TGS._sOnline=!1),window.cards&&cards.kik||TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Kik cards module was not loaded, or game is not being played in Kik Messenger"),window.cards&&cards.metrics&&cards.metrics.enableGoogleAnalytics("UA-29301358-44","kik.tresensa.com");var a="landscape";window.cards&&cards.kik&&("undefined"!=typeof window.GameConfig&&GameConfig.ORIENTATION&&(a=GameConfig.ORIENTATION),cards.browser.setOrientationLock(a)),this._mIsReady=!0,null!==this.onAdapterReady&&this.onAdapterReady.call()},connect:function(){if(window.cards&&cards.purchase){for(var a=[],b=TGS.Microtransactions.GetIAPProducts(),c=0;c<b.length;c++)b[c].partnerProductID&&a.push(b[c].partnerProductID);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"requesting Kik IAP items: "+a.toString()),cards.purchase.init(a)}else TGS.Debug.Log(TGS.Debug.LOG_WARNING,"Kik IAP is unavailable");this.getLoginStatus()},loginUser:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"prompting user to link to their Kik account..."),cards.kik.getUser(this.onLinkToKik.bind(this,a))},onLinkToKik:function(a,b){return b?"string"!=typeof b.username||b.username.length<1?(TGS._LoginFailed(a),void 0):(this._mUsername=b.username,this._mAvatarURL=b.thumbnail,this.userLoggedIn(a,b.username),void 0):(TGS._LoginCanceled(a),void 0)},purchaseItem:function(a){if(!cards.purchase)return a.internalErrorMessage="Kik IAP unavailable",a.userErrorMessage="In-app purchases are not available on this version of Kik Messenger.",TGS.Microtransactions._PartnerPurchaseFailed(a),void 0;var b=TGS.Microtransactions.GetIAPProduct(a.item.id);if(!b.partnerProductID)return a.internalErrorMessage="no Kik product id",a.userErrorMessage="Sorry, this item is not available on Kik Messenger yet.",TGS.Microtransactions._PartnerPurchaseFailed(a),void 0;var c={transaction:a.transactionID};cards.purchase(b.partnerProductID,c,this.onPurchaseResponse.bind(this,a))},onPurchaseResponse:function(a,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseResponse: "+JSON.stringify(b)),b?"string"!=typeof b.transactionId?(a.internalErrorMessage="Kik purchase failed - invalid transaction id",TGS.Microtransactions._PartnerPurchaseFailed(a)):(TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"transaction content: "+JSON.stringify(b.content)),a.partnerTransactionID=b.transactionId,TGS.Debug.Log(TGS.Debug.LOG_INFO,"Kik approved purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)):(a.internalErrorMessage="Kik purchase failed - no transaction object",a.userErrorMessage="The transaction was not completed.",TGS.Microtransactions._PartnerPurchaseFailed(a))},purchaseComplete:function(a){cards.purchase.complete(a.partnerTransactionID)},challenge:function(a){cards.kik.send({title:a.title,text:a.message})}},extend(TGS.Adapters.A0020,TGS.PartnerBridge);