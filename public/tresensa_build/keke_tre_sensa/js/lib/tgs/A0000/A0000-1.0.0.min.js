/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0000=function(){TGS.Adapters.A0000.superclass.constructor.call(this),this._mLoggedIn=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1,this._mMWAUserID=null},TGS.Adapters.A0000.prototype={autoLogin:function(){return!1},loginIcon:function(){return null},logoutIcon:function(){return null},supportsMicrotransactions:function(){return!0},costFactor:function(){return 100},currencyIcon:function(){return TGS._IMAGES_LOCATION+"arcadecredits.png"},formatNumber:function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},priceAsFormattedString:function(a){return this.formatNumber(a*this.costFactor())+" Credits"},connect:function(){this.getUserID()},getUserID:function(){this._mMWAUserID=TGS.localStorage.getItem("mwa_tmp"),this.getLoginStatus(),this._mMWAUserID&&!this._mLoggedIn&&this.userLoggedIn(new TGS.LoginRequest,this._mMWAUserID)},loginUser:function(){window.open("http://www.mobilewebarcade.com/wp-login.php","_self")},verifyLocalLogin:function(a){a===this._mMWAUserID?(TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"user "+a+" is logged in on MWA and in the adapter"),this.userLoggedIn(null,a)):(TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"user "+a+" logged out on MWA. Forcing logout in adapter..."),this.logoutUser())},purchaseItem:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Requesting users credit balance from TGS..."),a.usingCredits=!0;var b='{"partner":"'+TGS._sPartnerID+'","user":"'+TGS._sUserID+'"}';TGS.SendMessage("mtx/credits","get",b,this._onCheckBalanceSuccess.bind(this,a),this._onCheckBalanceFailure.bind(this,a))},_onCheckBalanceSuccess:function(a,b){var c=b.credits,d=a.item.price*this.costFactor();if(c>=d)TGS.Debug.Log(TGS.Debug.LOG_INFO,"User has enough credits to make purchase, asking for confirmation..."),TGS.OverlayMessage({title:"Confirm Purchase",message:"Do you agree to pay "+this.formatNumber(d)+" Arcade Credits to buy '"+a.item.title+"'? You will have "+this.formatNumber(c-d)+" Arcade Credits remaining.",buttonText:"No",buttonAction:this._onPurchaseCancel.bind(this,a),button2Text:"Yes",button2Callback:this._onPurchaseConfirmed.bind(this,a)});else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"User does not have enough credits"),a.internalErrorMessage="insufficient funds";var e={title:"Insufficient Funds!",message:"You have "+this.formatNumber(c)+" Arcade Credits. You need "+this.formatNumber(d)+" Arcade Credits to purchase this item.",buttonText:"",button2Image:TGS._IMAGES_LOCATION+"get_arcadecredits.png",button2Callback:TGS.Microtransactions.GetCredits};a.userErrorMessage=e,TGS.Microtransactions._PartnerPurchaseFailed(a)}},_onCheckBalanceFailure:function(a,b,c){a.internalErrorMessage="Credit balance check failed","undefined"!=typeof c.message&&(a.internalErrorMessage+=" - "+c.message),TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseCancel:function(a){a.internalErrorMessage="user cancel",a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseConfirmed:function(a){TGS.CloseMessageOverlay(),a.partnerTransactionID="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)}),TGS.Debug.Log(TGS.Debug.LOG_INFO,"User approved purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)}},extend(TGS.Adapters.A0000,TGS.PartnerBridge);