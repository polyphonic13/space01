/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */

var TGS=TGS||{};function extend(d,b){var a=d.prototype;var c=function(){};c.prototype=b.prototype;d.prototype=new c();d.prototype.constructor=d;d.superclass=b.prototype;if(b.prototype.constructor===Object.prototype.constructor){b.prototype.constructor=b}for(var e in a){if(a.hasOwnProperty(e)){d.prototype[e]=a[e]}}}if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b&&a?this:a,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}function getQueryString(){var b={},d=location.search.substring(1),c=/([^&=]+)=([^&]*)/g,a;while(a=c.exec(d)){b[decodeURIComponent(a[1])]=decodeURIComponent(a[2])}return b}function getDistributionPartner(){if(typeof CordovaConfig==="undefined"){var a=getQueryString()["dst"];return(typeof a==="string")?a:null}else{return(typeof CordovaConfig.DST_ID==="string")?CordovaConfig.DST_ID:null}}function loadScript(b,d){var c=document.getElementsByTagName("head")[0];var a=document.createElement("script");a.type="text/javascript";a.src=b;a.onreadystatechange=d;a.onload=d;c.appendChild(a)}TGS.PartnerBridge=function(){this._mIsReady=false;this._mLoggedIn=true;this._mFacebookLibLoaded=false;this._mFacebookInitialized=false;this._mFacebookAppID=null;this._mFacebookUserID=null;this._mFacebookAccessToken=null;this._mFacebookLoginRequiredCallback=null;this._mFacebookLoggedInCallback=null;this.onAdapterReady=null;this.onUserInfoAvailable=null};TGS.PartnerBridge.CreateRequiredAdapter=function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.CreateRequiredAdapter called");switch(a){case"Q0000":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating TestPartner adapter...");return new TGS.TestAdapter();break;case"A0001":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating iOS App Store adapter...");return new TGS.IOSAppStoreAdapter();break;case"A0002":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Google Play adapter...");return new TGS.GooglePlayAdapter();break;case"A0003":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Facebook adapter...");return new TGS.FacebookAdapter();break;case"A0005":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Games.com adapter...");return new TGS.GamesDotComAdapter();break;case"A0006":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Mocospace adapter...");return new TGS.MocospaceAdapter();break;case"A0011":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Amazon Web App Store adapter...");return new TGS.AmazonWebAppStoreAdapter();break;case"A0014":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating PlayPhone adapter...");return new TGS.PlayPhoneAdapter();break;case"A0020":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Kik adapter...");return new TGS.KikAdapter();break;case"A0021":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Windows Phone adapter");return new TGS.WindowsPhoneAdapter();break;case"A0025":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Funspot adapter...");return new TGS.FunspotAdapter();break;case"A0027":TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating Jooist adapter...");return new TGS.JooistAdapter();break;default:TGS.Debug.Log(TGS.Debug.LOG_INFO,"creating generic adapter...");return new TGS.GenericAdapter();break}return null};TGS.PartnerBridge.prototype={supportsPersistentUser:function(){return false},supportsMicrotransactions:function(){return false},allowsMicrotransactions:function(){return this.supportsMicrotransactions()},supportsDatastore:function(){return this.supportsPersistentUser()},autoLogin:function(){return true},supportsLogout:function(){return true},loginIcon:function(){return TGS._IMAGES_LOCATION+"test_login.png"},logoutIcon:function(){return TGS._IMAGES_LOCATION+"logout.png"},loggedIn:function(){return this._mLoggedIn},loginUser:function(a){if(this.autoLogin()){TGS.Debug.Log(TGS.Debug.LOG_INFO,"loginUser: user is already logged in");TGS._LoginSucceeded(a)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"this adapter does not do auto-login, but has not defined its own loginUser method");TGS._LoginFailed(a)}},logoutUser:function(a){if(TGS.AutoLogin()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"logoutUser: user cannot be logged out on this partner");TGS._LoginFailed(a);return}this._mLoggedIn=false;window.localStorage.removeItem(TGS._sLSKeys.TGS_loggedin_user);this.generateGuestUserID();TGS.DataStore._sSaveToTGSServer=false;TGS.DataStore.ClearLocalData();TGS._LoginSucceeded(a)},supportsLeaderboard:function(){return false},showLeaderboard:function(a){},submitScore:function(a){},submitScoreAndShow:function(a){},supportsChallenges:function(){return false},challengeIcon:function(){return null},challenge:function(a){},adsAllowed:function(){return true},facebookServicesAllowed:function(){return true},priceAsFormattedString:function(a){return Math.round(a*this.costFactor()).toString()},formattedPriceForItem:function(a){return this.priceAsFormattedString()},currencyIcon:function(){return null},getIAPProductsInfo:function(a){},purchaseItem:function(a){},serverHandlesMicrotransactionResponse:function(){return false},logTransactionBeforePartnerRequest:function(){return true},purchaseComplete:function(a){},gameWasLaunched:function(){},isReady:function(){return this._mIsReady},isFacebookReady:function(){return this._mFacebookInitialized},loggedIntoFacebook:function(){return this.isFacebookReady()&&this._mFacebookUserID!==null},enablePartnerUI:function(a){},costFactor:function(){return 1},masterInitialize:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.masterInitialize called");if(this.facebookServicesAllowed()){if(typeof FB!=="undefined"){TGS.Debug.Log(TGS.Debug.LOG_INFO,"detected Facebook library...");this.onFacebookLibraryLoaded()}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"loading Facebook library...");head.js((document.location.protocol==="https:"?"https:":"http:")+"//connect.facebook.net/en_US/all.js",this.onFacebookLibraryLoaded.bind(this))}}this.initialize()},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.initialize called");this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}},onFacebookLibraryLoaded:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"PartnerBridge.onFacebookLibraryLoaded called, Facebook library loaded successfully");this._mFacebookLibLoaded=true;if(!this._mFacebookInitialized){this.initFacebook()}},requiredPartnerProperties:function(){return""},requestGameInfo:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.requestGameInfo called");var b=this.requiredPartnerProperties();if(this.facebookServicesAllowed()){b+=b.length>0?",":"";b+='"facebook_app_id"'}var c='{"game":"'+a+'","partner":"'+TGS._sPartnerID+'","keys":['+b+"]}";TGS.SendMessage("partner_data","get",c,TGS.onGamePartnerInfoReceived,TGS.onGamePartnerInfoError)},masterConnect:function(a,c,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.masterConnect called");if(this.facebookServicesAllowed()){this._mFacebookAppID=a.facebook_app_id;if(this._mFacebookLibLoaded&&this._mFacebookAppID&&typeof(FB)!=="undefined"){this.initFacebook()}}this.connect(a);if(!TGS._sUserID){TGS.Debug.Log(TGS.Debug.LOG_INFO,"waiting on user id from partner... (TGS.onUserInfoAvailable has not been fired)")}},connect:function(a,c,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.connect called");TGS.MakeTGSReady()},initFacebook:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.initFacebook called");if(this._mFacebookInitialized||!this._mFacebookAppID){return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"Calling FB.init, appId = "+this._mFacebookAppID);FB.init({appId:this._mFacebookAppID,channelUrl:"//channel.html",status:true,cookie:true,xfbml:true});FB.Event.subscribe("auth.authResponseChange",function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"the Facebook session status changed to "+a.status)});this._mFacebookInitialized=true},loginToFacebook:function(a,b){this._mFacebookLoginRequiredCallback=a;this._mFacebookLoggedInCallback=b;if(!this._mFacebookInitialized){this.initFacebook()}FB.getLoginStatus(this.onGetFBLoginStatus.bind(this))},onGetFBLoginStatus:function(a){if(a.status==="connected"){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user is logged into Facebook and authorized the app");this._mFacebookUserID=a.authResponse.userID;this._mFacebookAccessToken=a.authResponse.accessToken;if(this._mFacebookLoggedInCallback!==null){this._mFacebookLoggedInCallback.call(this,this._mFacebookUserID)}}else{if(a.status==="not_authorized"){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user is logged into Facebook but has not authorized the app");if(this._mFacebookLoginRequiredCallback!==null){this._mFacebookLoginRequiredCallback.call(this)}}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"user is not logged into Facebook");if(this._mFacebookLoginRequiredCallback!==null){this._mFacebookLoginRequiredCallback.call(this)}}}},promptForFacebookAuthorization:function(b){this._mFacebookLoginRequiredCallback=b?b:null;TGS.Debug.Log(TGS.Debug.LOG_INFO,"prompting user for Facebook login and/or app authorization...");var a="publish_actions,user_games_activity";if(TGS.Leaderboard.RequestUserLocation){a=a+",user_location"}FB.login(this.onGetFBLoginStatus.bind(this),{scope:a})},getLoginStatus:function(){var a=window.localStorage.getItem(TGS._sLSKeys.TGS_userid);if(!a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"userID was not available in local storage");a=this.generateGuestUserID()}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"userID retrieved from local storage: "+a)}if(a===window.localStorage.getItem(TGS._sLSKeys.TGS_loggedin_user)){this.verifyLocalLogin(a)}if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,a)}},generateGuestUserID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e=="x"?d:(d&3|8);return b.toString(16)});TGS.Debug.Log(TGS.Debug.LOG_INFO,"generated GUID for guest: "+a);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"saving userID to local storage: "+a);window.localStorage.setItem(TGS._sLSKeys.TGS_userid,a);return a},verifyLocalLogin:function(a){this.userLoggedIn(null,a)},userLoggedIn:function(c,e){var d=window.localStorage.getItem(TGS._sLSKeys.TGS_loggedin_user);if(d&&this._mLoggedIn){if(e===d){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"PartnerBridge.userLoggedIn: user "+e+" is already logged in")}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"PartnerBridge.userLoggedIn: there is already a logged in user");TGS._LoginFailed(c)}return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"user '"+e+"' is logging in...");var b=d===e.toString();TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"(user was "+(b?"":"NOT")+" previously logged in)");var a=d==null;window.localStorage.setItem(TGS._sLSKeys.TGS_loggedin_user,e.toString());window.localStorage.setItem(TGS._sLSKeys.TGS_userid,e);TGS._sUserID=e.toString();this._mLoggedIn=true;TGS.DataStore._sSaveToTGSServer=true;if(c){TGS.DataStore.ReloadData({location:b?"local":"remote",useLocalIfEmpty:a,onSuccess:TGS._LoginSucceeded.bind(null,c)})}else{TGS._LoginSucceeded()}},updateLocalStorageData:function(){var a=window.localStorage.getItem("TGS_userid");if(a){window.localStorage.setItem(TGS._sLSKeys.TGS_userid,a);window.localStorage.removeItem("TGS_userid")}var b=window.localStorage.getItem("TGS_datastore");if(b){window.localStorage.setItem(TGS._sLSKeys.TGS_datastore,b);window.localStorage.removeItem("TGS_datastore")}},getImageURL:function(c){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"PartnerBridge.getImageURL called");var a=c.item.image;if(typeof(window.TGE)!=="undefined"){var b=window.TGE.AssetManager;var d=b.GetImage(c.item.image);if(d){a=d.src;TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"full image url is "+a)}}return a}};TGS.GenericAdapter=function(){TGS.GenericAdapter.superclass.constructor.call(this)};TGS.GenericAdapter.prototype={};extend(TGS.GenericAdapter,TGS.PartnerBridge);TGS.TestAdapter=function(){TGS.TestAdapter.superclass.constructor.call(this);this._mLoggedIn=false;TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true};TGS.TestAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},autoLogin:function(){return false},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},currencyIcon:function(){return TGS._IMAGES_LOCATION+"testicon.png"},gameWasLaunched:function(){if(typeof(window.TGE)!=="undefined"&&TGE.Game.GetInstance()){TGE.Button.DefaultVerticalPressOffset=3}},connect:function(a){this.getLoginStatus()},loginUser:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"prompting user to login...");var b=window.prompt("LOGIN (enter your username):","");if(!b){TGS._LoginCanceled(a);return}else{if(typeof(b)!=="string"||b.length<1){TGS._LoginFailed(a);return}}this.userLoggedIn(a,b)},purchaseItem:function(a){a.partnerTransactionID=~~(Math.random()*2147483648);setTimeout(this.openPurchase.bind(this,a),2000)},openPurchase:function(b){var a="Do you agree to pay "+this.priceAsFormattedString(b.item.price)+" to buy "+b.item.title+"?";var c=confirm(a);setTimeout(this.closePurchase.bind(this,c,b),1000)},closePurchase:function(b,a){if(b){TGS.Debug.Log(TGS.Debug.LOG_INFO,"TestAdapter approved purchase of transaction "+a.transactionID);TGS.Microtransactions._PartnerPurchaseSuccessful(a)}else{a.internalErrorMessage="user cancelled";a.userErrorMessage="";TGS.Microtransactions._PartnerPurchaseFailed(a)}}};extend(TGS.TestAdapter,TGS.PartnerBridge);TGS.PlayPhoneAdapter=function(){TGS.PlayPhoneAdapter.superclass.constructor.call(this);this._mAppID=null};TGS.PlayPhoneAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},supportsLeaderboard:function(){return true},facebookServicesAllowed:function(){return false},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},requiredPartnerProperties:function(){return'"playphone_game_id"'},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"deferring PlayPhone library load");this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}},connect:function(c){this._mAppID=c.playphone_game_id;var d="production";var b="";if(false){d="staging";b="&debug=true"}var a="http://html5sdk.galaxy.gs/PSGN.js?env="+d+"&app_id="+this._mAppID+b;TGS.Debug.Log(TGS.Debug.LOG_INFO,"loading PlayPhone library... "+a);head.js(a,this.onLibraryLoad.bind(this))},onLibraryLoad:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"PlayPhone library loaded successfully");playphone.PSGN.Auth.onlogin(this._onAuth.bind(this))},_onAuth:function(){userID=localStorage.getItem("uguid");if(!userID){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"uguid in local storage is invalid: "+userID);return}if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,userID)}},_onGetData:function(a){if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,userID)}},showLeaderboard:function(a){},submitScore:function(a){},submitScoreAndShow:function(c){var d=c.leaderboardID?c.leaderboardID:0;var a=TGS.Leaderboard.GetLeaderboardDescriptor(d);if(a===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard "+c.leaderboardID);return}var b=a.partnerLeaderboardID;if(b===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no PlayPhone id found for leaderboard "+c.leaderboardID);return}playphone.PSGN.Player("leaderboard",b,c.score)},purchaseItem:function(b){var a=b.item.partnerProductID;if(!a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no PlayPhone IAP id found for item "+b.item.id);return}playphone.PSGN.Billing(a,this._purchaseResponse.bind(this))},_purchaseResponse:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"billing request returned, assuming success...?")}};extend(TGS.PlayPhoneAdapter,TGS.PartnerBridge);TGS.FacebookAdapter=function(){TGS.FacebookAdapter.superclass.constructor.call(this);this._mLoggedIn=false;TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true};TGS.FacebookAdapter.prototype={supportsPersistentUser:function(){return true},autoLogin:function(){return false},loginIcon:function(){return TGS._IMAGES_LOCATION+"facebook_login.png"},supportsMicrotransactions:function(){return true},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},serverHandlesMicrotransactionResponse:function(){return true},onFacebookLibraryLoaded:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Facebook library loaded successfully");this._mFacebookLibLoaded=true;this._mIsReady=true;if(!this._mFacebookInitialized){this.initFacebook()}if(this.onAdapterReady!==null){this.onAdapterReady.call()}},initialize:function(){},connect:function(a){this.getLoginStatus()},loginUser:function(a){this.loginToFacebook(this.promptForFacebookAuthorization.bind(this,TGS._LoginCanceled.bind(null,a)),this.userLoggedIn.bind(this,a))},logoutUser:function(a){TGS.FacebookAdapter.superclass.logoutUser.call(this,a);FB.logout(function(){window.location.reload()})},loggedIntoFacebook:function(){return this._mLoggedIn},verifyLocalLogin:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user is logged in locally, verifying Facebook authentication...");this.loginToFacebook(this.logoutUser.bind(this),this.userLoggedIn.bind(this,null))},purchaseItem:function(b){var a=TGS._SERVER_LOCATION+"mtx/facebook/iap_item.php?game="+TGS._sGameID+"&iap_id="+b.item.id;TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,a);var c={method:"pay",action:"purchaseitem",product:a,request_id:b.transactionID};FB.ui(c,this.fbBuyCallback.bind(this,b))},fbBuyCallback:function(b,a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"FB data: "+JSON.stringify(a));if(a.error_code){b.internalErrorMessage=a.error_message;if(a.error_code===1383010){b.userErrorMessage=""}TGS.Microtransactions._PartnerPurchaseFailed(b);return}b.partnerTransactionID=a.payment_id;if(a.status==="completed"){var c='{"facebook_signed_request":"'+a.signed_request+'","facebook_transaction_id":"'+a.payment_id+'","game":"'+TGS._sGameID+'","user":"'+TGS._sUserID+'","tresensa_transaction_id":'+b.transactionID+',"game_data_changes":'+JSON.stringify(b.gameDataUpdates)+"}";TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending successful purchase data for verification: "+c);TGS.SendMessage("mtx/facebook/callback","verify",c,this._onVerificationSuccess.bind(this,b),this._onVerificationError.bind(this,b))}else{if(a.status==="failed"){b.internalErrorMessage="failed";TGS.Microtransactions._PartnerPurchaseFailed(b)}else{if(a.status==="initiated"){b.internalErrorMessage="initiated";TGS.Microtransactions._PartnerPurchaseFailed(b)}}}},_onVerificationSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Facebook purcahse response was verified");TGS.Microtransactions._PartnerPurchaseSuccessful(a)},_onVerificationError:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Facebook response verification failed");a.internalErrorMessage="Facebook response verification failed";TGS.Microtransactions._PartnerPurchaseFailed(a)},};extend(TGS.FacebookAdapter,TGS.PartnerBridge);TGS.MocospaceAdapter=function(){TGS.MocospaceAdapter.superclass.constructor.call(this);if(typeof(window.TGE)!=="undefined"){TGE.DisableViewportResizing=true;TGE.DisableLostFocusPause=true}this._mDoDoubleResize=true;if(typeof(window.GameConfig.Leaderboard)!=="undefined"){GameConfig.Leaderboard.ENABLED=false}};TGS.MocospaceAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},facebookServicesAllowed:function(){return false},costFactor:function(){return 10},currencyIcon:function(){return TGS._IMAGES_LOCATION+"mocogold.png"},serverHandlesMicrotransactionResponse:function(){return true},gameWasLaunched:function(){this._forceResizeIFrame()},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"loading Mocospace library...");head.js("http://img.mocospace.com.edgesuite.net/wk/js/opensocial/opensocial.js",this.onLibraryLoad.bind(this))},onLibraryLoad:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Mocospace library loaded successfully");this._mIsReady=true;MocoSpace.registerOrientationListener(this._resizeGameIFrame.bind(this));MocoSpace.getViewPort(this._resizeGameIFrame.bind(this));if(this.onAdapterReady!==null){this.onAdapterReady.call()}},_resizeGameIFrame:function(a,c,b){if(typeof(window.TGE)!=="undefined"&&TGE.Game.GetInstance()){TGE.Game.GetInstance()._resizeToFit(c,a);if(this._mDoDoubleResize&&TGE.BrowserDetect.platform==="Android"&&TGE.BrowserDetect.browser==="Mozilla"){setTimeout(this._forceResizeIFrame.bind(this),500);this._mDoDoubleResize=false}else{this._mDoDoubleResize=true}}},_forceResizeIFrame:function(){MocoSpace.getViewPort(this._resizeGameIFrame.bind(this))},connect:function(b){if(TGS._sFakeConnections){TGS.Debug.Log(TGS.Debug.LOG_INFO,"giving fake Mocospace user info to TGS");var a="56421477";if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,a)}return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"fetching player info...");var c={};c[opensocial.PeopleRequestFields.PROFILE_DETAILS]=[];opensocial.fetchPerson("@me",c,this.onFetchPerson.bind(this))},onFetchPerson:function(b){if(b.hadError()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not retrieve user id: "+b.getErrorMessage())}else{var a=b.getData().getField(opensocial.Person.Field.ID);if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,a)}}},purchaseItem:function(b){var a=this.getImageURL(b);var c=b.item.price*this.costFactor();MocoSpace.goldTransaction(c,b.item.title,{onSuccess:this._onPurchaseSuccess.bind(this,b),onError:this._onPurchaseError.bind(this,b),onAbort:this._onPurchaseAbort.bind(this,b),onAsync:this._onPurchaseAsync.bind(this,b)},a)},_onPurchaseSuccess:function(d,g,c,a){d.partnerTransactionID=g;var b=d.item;var f=b.price*this.costFactor();var e='{"moco_transaction_token":"'+a+'","moco_transaction_id":"'+g+'","moco_transaction_cost":"'+f+'","moco_transaction_timestamp":"'+c+'","game":"'+TGS._sGameID+'","tresensa_transaction_id":'+d.transactionID+',"user":"'+TGS._sUserID+'","game_data_changes":'+JSON.stringify(d.gameDataUpdates)+"}";TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending successful purchase data for verification: "+e);TGS.SendMessage("mtx/mocospace/callback","verify",e,this._onVerificationSuccess.bind(this,d),this._onVerificationError.bind(this,d))},_onVerificationSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Mocospace token was verified");TGS.Microtransactions._PartnerPurchaseSuccessful(a)},_onVerificationError:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Mocospace token verification failed");a.internalErrorMessage="Mocospace token verification failed";TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseError:function(a,b){a.internalErrorMessage="Mocospace error: "+b;TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseAbort:function(a){a.internalErrorMessage="user cancelled";a.userErrorMessage="";TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseAsync:function(a){a.internalErrorMessage="insufficient funds";a.userErrorMessage="";TGS.Microtransactions._PartnerPurchaseFailed(a)}};extend(TGS.MocospaceAdapter,TGS.PartnerBridge);TGS.GamesDotComAdapter=function(){TGS.GamesDotComAdapter.superclass.constructor.call(this);this._mGameSecret=""};TGS.GamesDotComAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},costFactor:function(){return 0.1},priceAsFormattedString:function(a){return"$"+(a*this.costFactor()).toFixed(2)},logTransactionBeforePartnerRequest:function(){return false},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"loading Games.com library...");var a=document.location.protocol==="https:"?"https://s.aolcdn.com/gamesdevcenter/sdk/v2/GamesSDK.js":"http://o.aolcdn.com/gamesdevcenter/sdk/v2/GamesSDK.js";head.js(a,this.onLibraryLoad.bind(this))},onLibraryLoad:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Games.com library loaded successfully");this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}},requiredPartnerProperties:function(){return'"gamescom_game_id","gamescom_game_secret"'},connect:function(a){this._mGameSecret=a.gamescom_game_secret;GAMESAPI.beginGameSession(this._onBeginSuccess.bind(this),this._onBeginError.bind(this))},_onBeginSuccess:function(a){if(a.statusCode!==200){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not connect to Games.com: error code "+a.statusCode);return}GAMESAPI.setGameSecret(this._mGameSecret);var b=a.data.playerInfo.playerId;if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,b)}},_onBeginError:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not connect to Games.com: "+a.statusText)},submitScore:function(a){},achievementEarned:function(a){},purchaseItem:function(b){var a=b.item;GAMESAPI.TRANSACTION.startTransaction(a.price*this.costFactor(),b.item.id,a.title,this._purchaseItemCallback.bind(this,b),this._onPurchaseError.bind(this,b))},_purchaseItemCallback:function(b,a){b.partnerTransactionID=a.data.orderId;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Games.com approved purchase of transaction "+b.transactionID);TGS.Microtransactions._PartnerPurchaseSuccessful(b)},_onPurchaseError:function(b,a){b.internalErrorMessage=a.statusCode+" - "+a.statusText;if(a.statusCode===475){b.userErrorMessage=""}TGS.Microtransactions._PartnerPurchaseFailed(b)}};extend(TGS.GamesDotComAdapter,TGS.PartnerBridge);TGS.IOSAppStoreAdapter=function(){TGS.IOSAppStoreAdapter.superclass.constructor.call(this);this._mUserOnline=true;TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true};TGS.IOSAppStoreAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return this._mUserOnline},allowsMicrotransactions:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - allowsMicrotransactions: "+this._isPurchaseAllowed);return this._isPurchaseAllowed},supportsLeaderboard:function(){return true},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},facebookServicesAllowed:function(){return true},setIAPProducts:function(){if(TGS.Microtransactions._sIAPProducts==null||TGS.Microtransactions._sIAPProducts.length<1){TGS.Microtransactions._sIAPProducts=[]}},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.initialize called, initializing iOS App Store Adapter");this._availableProducts=null;if(window.plugins){window.plugins.inAppPurchaseManager.onPurchased=function(c,b,a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - onPurchased: "+b);var d=TGS.Microtransactions._PendingRequest;if(d){if(b!=d.item.partnerProductID){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - onPurchased think we are waiting for "+d.item.partnerProductID+" but got "+b)}else{d.partnerTransactionID=c;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Apple approved purchase of transaction "+d.transactionID+", "+d.partnerTransactionID);TGS.Microtransactions._PartnerPurchaseSuccessful(d)}}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - onPurchased has no pending request")}};window.plugins.inAppPurchaseManager.onRestored=function(c,b,a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - restored: "+b)};window.plugins.inAppPurchaseManager.onFailed=function(a,c){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - failed: "+c);var b=TGS.Microtransactions._PendingRequest;if(b){b.internalErrorMessage=c;TGS.Microtransactions._PartnerPurchaseFailed(b)}};window.plugins.inAppPurchaseManager.canPurchase(this.userAllowsPurchase.bind(this));window.gameCenter.onshow=function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"GameCenter triggered onshow")};window.gameCenter.onhide=function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"GameCenter triggered onhide")};window.gameCenter.authenticate(this.authSuccess.bind(this),this.authFailure.bind(this))}this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}},requiredPartnerProperties:function(){return'"gamecenter_leaderboard_id"'},initFacebook:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.initFacebook called");if(!window.FB||this._mFacebookInitialized||!this._mFacebookAppID||typeof(window.CDV)==="undefined"){return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.initFacebook calling FB.init, appId = "+this._mFacebookAppID);FB.init({appId:this._mFacebookAppID,nativeInterface:CDV.FB,useCachedDialogs:false});this._mFacebookInitialized=true},connect:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.connect called");var b=true;for(var c in a){if(a.hasOwnProperty(c)){b=false;break}}if(b){TGS.Debug.Log(TGS.Debug.LOG_INFO,"TGS communication failed - user is probably offline");this._mUserOnline=false}if(!this._mFacebookInitialized){this.initFacebook()}if(this._mUserOnline&&window.plugins){this.setIAPProducts();this.getIAPProductsResponse(TGS.Microtransactions.GetIAPProducts(),null)}this.updateLocalStorageData();this.getLoginStatus()},getIAPProductsResponse:function(b,c){if(c!=null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts error "+c.message)}else{if(b!=null&&b.length>0){TGS.Debug.Log(TGS.Debug.LOG_INFO,"getIAPProducts success with "+b);this._availableProducts=b;var a=[];for(var d=0;d<b.length;d++){var e=b[d];if(e.partnerProductID!=null&&e.partnerProductID.length>0){a[d]=e.partnerProductID;TGS.Debug.Log(TGS.Debug.LOG_INFO,"getIAPProducts added "+e.partnerProductID)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts error partnerProductID is null for "+e.title)}}if(a.length>0){this.getIAPProductsInfo(a)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts no products defined!")}}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts got no products!");this._availableProducts=null}}},getIAPProductsInfo:function(a){if(Object.prototype.toString.call(a).slice(8,-1)==="String"){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Calling IAP requestProductData");window.plugins.inAppPurchaseManager.requestProductData(a,function(b,e,d,c){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - productId: "+b+" title: "+e+" description: "+d+" price: "+c)},function(b){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - Invalid product id: "+b)})}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Calling IAP requestProductsData");window.plugins.inAppPurchaseManager.requestProductsData(a,function(e,c){var f="";for(var b=0;b<e.length;b++){if(f.length>0){f+=", "}else{f+="["}var d=e[b];f+='{id:"'+d.id+'", decription:"'+d.description+'", price:"'+d.price+'"}'}f+="]";if(c!=null&&c.length>0){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase requestProductsData: "+f+"; Invalids="+c)}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase requestProductsData: "+f)}})}},userAllowsPurchase:function(a){this._isPurchaseAllowed=a;TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - canPurchase: "+this._isPurchaseAllowed)},purchaseItem:function(b){TGS.Debug.Log(TGS.Debug.LOG_INFO,"iOS purchase request for "+b.item.id+" ("+b.item.partnerProductID+").");var a=b.item.partnerProductID;var c=1;window.plugins.inAppPurchaseManager.makePurchase(a,c)},submitScore:function(b){var d=b.leaderboardID?b.leaderboardID:0;var a=TGS.Leaderboard.GetLeaderboardDescriptor(d);if(a===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard id "+b.leaderboardID);return}var c=a.partnerLeaderboardID;if(c===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no iOS sku found for leaderboard id "+b.leaderboardID);return}if(!window.gameCenter){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter module is not available");return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"submitting score "+b.score+" to GameCenter leaderboard "+c);window.gameCenter.reportScore(c,b.score,this.scoreSuccess.bind(this),this.scoreFailure.bind(this))},showLeaderboard:function(b){var d=b.leaderboardID?b.leaderboardID:0;var a=TGS.Leaderboard.GetLeaderboardDescriptor(d);if(a===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard id "+b.leaderboardID);return}var c=a.partnerLeaderboardID;if(c===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no iOS sku found for leaderboard id "+b.leaderboardID);return}if(!window.gameCenter){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter module is not available");return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"showing GameCenter leaderboard "+c+"...");window.gameCenter.showLeaderboard(c)},submitScoreAndShow:function(b){var d=b.leaderboardID?b.leaderboardID:0;var a=TGS.Leaderboard.GetLeaderboardDescriptor(d);if(a===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard id "+b.leaderboardID);return}var c=a.partnerLeaderboardID;if(c===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no iOS sku found for leaderboard id "+b.leaderboardID);return}if(!window.gameCenter){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter module is not available");return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"submitting score "+b.score+" to GameCenter leaderboard "+c);window.gameCenter.reportScore(c,b.score,this.scoreSuccessShowLeaderboard.bind(this,c),this.scoreFailure.bind(this))},achievementEarned:function(a){},scoreSuccessShowLeaderboard:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter score reported, showing leaderboard...");window.gameCenter.showLeaderboard(a)},scoreSuccess:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter score reported")},scoreFailure:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter score failure: "+a)},achievementSuccess:function(){window.gameCenter.showAchievements();TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter get achievement success")},achievementFailure:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter get achievement failure:\n"+a)},authSuccess:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter Authentication success")},authFailure:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter Authentication failure:\n"+a+"\nPlease sign in using the Game Center application")},requestAuthorization:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"GameCenter requestAuthorization called");window.gameCenter.authenticate(this.authSuccess.bind(this),this.authFailure.bind(this))}};extend(TGS.IOSAppStoreAdapter,TGS.PartnerBridge);TGS.AmazonWebAppStoreAdapter=function(){TGS.AmazonWebAppStoreAdapter.superclass.constructor.call(this);this._mTestMode=false;this._mAllowSandboxMode=false;TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true};TGS.AmazonWebAppStoreAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},facebookServicesAllowed:function(){return false},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},requiredPartnerProperties:function(){return'"amazon_sandbox_mode"'},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"loading Amazon Web App Store library...");var a=[];a.push("https://amazon-web-app-resources.s3.amazonaws.com/v0/latest/Amazon-Web-App-API.min.js");if(this._mTestMode){a.push("https://amazon-web-app-resources.s3.amazonaws.com/v0/latest/Amazon-Web-App-API-tester.min.js")}head.js.apply(this,a);head.ready(this.onLibraryLoad.bind(this))},onLibraryLoad:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon Web App Store library loaded callback fired");this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}},connect:function(a){this._mAllowSandboxMode=a.amazon_sandbox_mode===1;this.getLoginStatus();if(!window.amzn_wa){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Amazon module is not available")}else{if(!amzn_wa.IAP){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Amazon IAP module is not available")}else{if(this._mTestMode){amzn_wa.enableApiTester(amzn_wa_tester)}TGS.Debug.Log(TGS.Debug.LOG_INFO,"registering observers...");amzn_wa.IAP.registerObserver({onSdkAvailable:this.onSDKAvailable.bind(this),onGetUserIdResponse:this.onGetUserIDResponse.bind(this),onItemDataResponse:this.onItemDataResponse.bind(this),onPurchaseResponse:this.onPurchaseResponse.bind(this),onPurchaseUpdatesResponse:this.onPurchaseUpdatesResponse.bind(this)})}}},onSDKAvailable:function(a){var b=false;if(typeof(window.GameConfig)!=="undefined"&&GameConfig.PROD_ENV===true){b=true}if(b&&!this._mAllowSandboxMode&&a.isSandboxMode){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"the Amazon Tester App cannot be used on a game deployed for production");return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon SDK is ready, requesting user id...");amzn_wa.IAP.getUserId()},onGetUserIDResponse:function(a){if(a.getUserIdRequestStatus===amzn_wa.IAP.UserIdStatus.SUCCESSFUL){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon user id: "+a.userId);this.userLoggedIn(new TGS.LoginRequest(),a.userId)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not retrieve Amazon user id")}},onItemDataResponse:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onItemDataResponse: "+JSON.stringify(a))},onPurchaseResponse:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseResponse: "+JSON.stringify(a));var b=TGS.Microtransactions._PendingRequest;if(!b){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"received an unrequested purchase response: "+JSON.stringify(a));return}if(a.purchaseRequestStatus===amzn_wa.IAP.PurchaseStatus.SUCCESSFUL){b.partnerTransactionID=a.receipt.purchaseToken;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon approved purchase of transaction "+b.transactionID);TGS.Microtransactions._PartnerPurchaseSuccessful(b)}else{b.internalErrorMessage="Amazon request status: "+a.purchaseRequestStatus;TGS.Microtransactions._PartnerPurchaseFailed(b)}},onPurchaseUpdatesResponse:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseUpdatesResponse: "+JSON.stringify(a));for(var b=0;b<a.receipts.length;b++){}},purchaseItem:function(b){if(!window.amzn_wa||!window.amzn_wa.IAP){b.internalErrorMessage="Amazon SDK was unavailable";b.userErrorMessage="Could not connect to Amazon - make sure the Amazon Appstore app is running and restart the game.";TGS.Microtransactions._PartnerPurchaseFailed(b);return}var a=TGS._sGameID+"."+b.item.id.toString();TGS.Debug.Log(TGS.Debug.LOG_INFO,"requesting purchase for SKU item: "+a+" from Amazon...");amzn_wa.IAP.purchaseItem(a)}};extend(TGS.AmazonWebAppStoreAdapter,TGS.PartnerBridge);TGS.KikAdapter=function(){TGS.KikAdapter.superclass.constructor.call(this);this._mLoggedIn=false;TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true};TGS.KikAdapter.prototype={facebookServicesAllowed:function(){return false},supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},autoLogin:function(){return false},supportsLogout:function(){return false},loginIcon:function(){return TGS._IMAGES_LOCATION+"kik_login.png"},supportsChallenges:function(){return true},challengeIcon:function(){return TGS._IMAGES_LOCATION+"kik.png"},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},formattedPriceForItem:function(a){return"$"+((aPrice*this.costFactor()/100)-0.01).toFixed(2)},gameWasLaunched:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Kik gameWasLaunched");if(window.cards&&cards.browser&&window.TGE&&TGE.Game.GetInstance()){cards.browser.on("background",this.onBackground.bind(this));cards.browser.on("foreground",this.onForeground.bind(this));TGE.Button.DefaultVerticalPressOffset=4}},onBackground:function(){if(typeof(window.TGE)!=="undefined"&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();TGS.Debug.Log(TGS.Debug.LOG_INFO,"pausing the game and halting update loop");TGE.Game.GetInstance().PauseGame(true);if(a._mRAFID){TGS.Debug.Log(TGS.Debug.LOG_INFO,"cancelling requestAnimationFrame...");cancelAnimationFrame(a._mRAFID);a._mRAFID=null}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already null?")}TGS.Debug.Log(TGS.Debug.LOG_INFO,"disabling updates...");a._mUpdatingEnabled=false}},onForeground:function(){if(typeof(window.TGE)!=="undefined"&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();if(a._mRAFID===null){TGS.Debug.Log(TGS.Debug.LOG_INFO,"restarting requestAnimationFrame...");if(typeof(a.Update)!=="undefined"){a._mRAFID=requestAnimationFrame(a.Update.bind(a))}else{a._mRAFID=requestAnimationFrame(a._update.bind(a))}}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already active?")}TGS.Debug.Log(TGS.Debug.LOG_INFO,"turning updating back on with a 30 frame delay");a._mUpdatingEnabled=true;a._mUpdateSkips=30}},initialize:function(){if(navigator.onLine===false){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"navigator.onLine is false - TGS going into OFFLINE mode");TGS._sOnline=false}TGS.Debug.Log(TGS.Debug.LOG_INFO,"loading Kik library...");var a=[];a.push("//static.tresensa.com/lib/cards.min.js");head.js.apply(this,a);head.ready(this.onLibraryLoad.bind(this))},onLibraryLoad:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Kik library loaded successfully");if(window.cards&&cards.metrics){cards.metrics.enableGoogleAnalytics()}var a="landscape";if(window.cards&&cards.kik){if(typeof(window.GameConfig)!=="undefined"&&GameConfig.ORIENTATION){a=GameConfig.ORIENTATION}cards.browser.setOrientationLock(a)}this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}},connect:function(b){if(!window.cards||!cards.kik){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Kik cards module is unavailable")}if(!window.cards||!cards.purchase){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"Kik IAP is unavailable")}else{var a=[];var d=TGS.Microtransactions.GetIAPProducts();for(var c=0;c<d.length;c++){if(d[c].partnerProductID){a.push(d[c].partnerProductID)}}TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"requesting Kik IAP items: "+a.toString());cards.purchase.init(a)}this.getLoginStatus()},loginUser:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"prompting user to link to their Kik account...");cards.kik.getUser(this.onLinkToKik.bind(this,a))},onLinkToKik:function(b,a){if(!a){TGS._LoginCanceled(b);return}else{if(typeof(a.username)!=="string"||a.username.length<1){TGS._LoginFailed(b);return}}this.userLoggedIn(b,a.username)},purchaseItem:function(b){if(!cards.purchase){b.internalErrorMessage="Kik IAP unavailable";b.userErrorMessage="In-app purchases are not available on this version of Kik Messenger.";TGS.Microtransactions._PartnerPurchaseFailed(b);return}var a=TGS.Microtransactions.GetIAPProduct(b.item.id);if(!a.partnerProductID){b.internalErrorMessage="no Kik product id";b.userErrorMessage="Sorry, this item is not available on Kik Messenger yet.";TGS.Microtransactions._PartnerPurchaseFailed(b);return}var c={transaction:b.transactionID};cards.purchase(a.partnerProductID,c,this.onPurchaseResponse.bind(this,b))},onPurchaseResponse:function(a,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseResponse: "+JSON.stringify(b));if(!b){a.internalErrorMessage="Kik purchase failed - no transaction object";a.userErrorMessage="The transaction was not completed.";TGS.Microtransactions._PartnerPurchaseFailed(a)}else{if(typeof(b.transactionId)!=="string"){a.internalErrorMessage="Kik purchase failed - invalid transaction id";TGS.Microtransactions._PartnerPurchaseFailed(a)}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"transaction content: "+JSON.stringify(b.content));a.partnerTransactionID=b.transactionId;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Kik approved purchase of transaction "+a.transactionID);TGS.Microtransactions._PartnerPurchaseSuccessful(a)}}},purchaseComplete:function(a){cards.purchase.complete(a.partnerTransactionID)},challenge:function(a){cards.kik.send({title:a.title,text:a.message})}};extend(TGS.KikAdapter,TGS.PartnerBridge);TGS.GooglePlayAdapter=function(){TGS.GooglePlayAdapter.superclass.constructor.call(this);TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true};TGS.GooglePlayAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},facebookServicesAllowed:function(){return false},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},requiredPartnerProperties:function(){return""},initialize:function(){this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play adapter initialized.")},onInitSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play adapter connected.");this.updateLocalStorageData();this.getLoginStatus()},onInitFailed:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play adapter init fails with "+a);this._mIsReady=false},connect:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play adapter connecting...");inappbilling.init(this.onInitSuccess.bind(this),this.onInitFailed.bind(this))},onPurchaseSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play purchase accepted. "+JSON.stringify(a));var c=TGS.Microtransactions._PendingRequest;if(c!=null){c.partnerTransactionID=a;var b=c.item.partnerProductID;inappbilling.consumePurchase(this.onConsumePurchaseSuccess.bind(this),this.onConsumePurchaseFailed.bind(this),b);TGS.Microtransactions._PartnerPurchaseSuccessful(c)}},onPurchaseFailed:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play purchase failed "+a);var c=TGS.Microtransactions._PendingRequest;if(c!=null){if(a.indexOf("Already Owned")>=0){var b=c.item.partnerProductID;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play purchase already owned invoking consume/purchase for "+b);inappbilling.consumePurchase(this.onConsumePurchaseSuccessRebuy.bind(this),this.onConsumePurchaseFailed.bind(this),b)}else{c.internalErrorMessage="Google Play status: "+a.status;TGS.Microtransactions._PartnerPurchaseFailed(c)}}},onConsumePurchaseSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play consume purchase success.")},onConsumePurchaseSuccessRebuy:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play consume purchase success but now we should rebuy this item.");var c=TGS.Microtransactions._PendingRequest;if(c!=null){var b=c.item.partnerProductID;inappbilling.buy(this.onPurchaseSuccess.bind(this),this.onPurchaseFailed.bind(this),b)}},onConsumePurchaseFailed:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play consume purchase failed "+a)},purchaseItem:function(b){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Google Play purchase request for "+b.item.id+" ("+b.item.partnerProductID+").");var a=b.item.partnerProductID;inappbilling.buy(this.onPurchaseSuccess.bind(this),this.onPurchaseFailed.bind(this),a)}};extend(TGS.GooglePlayAdapter,TGS.PartnerBridge);TGS.WindowsPhoneAdapter=function(){TGS.WindowsPhoneAdapter.superclass.constructor.call(this);this._mTestMode=false;this._mAllowSandboxMode=false;this._isPurchaseAllowed=true;TGS.DataStore._sSaveToLocalStorage=true;TGS.DataStore._sSaveToTGSServer=false;TGS._sContinueOnPartnerInfoFail=true;this._mUserOnline=true};TGS.WindowsPhoneAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return this._mUserOnline},allowsMicrotransactions:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - allowsMicrotransactions: "+this._isPurchaseAllowed);return this._isPurchaseAllowed},facebookServicesAllowed:function(){return true},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+((a*this.costFactor()/100)-0.01).toFixed(2)},requiredPartnerProperties:function(){return""},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"WindowsPhoneAdapter.initialize initializing Windows 8 Phone Store Adapter");if(window.plugins){window.plugins.inAppPurchaseManager.onPurchased=function(c,b,a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - onPurchased: "+b);var d=TGS.Microtransactions._PendingRequest;if(d){if(b!=d.item.partnerProductID){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - onPurchased think we are waiting for "+d.item.partnerProductID+" but got "+b)}else{d.partnerTransactionID=c;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Apple approved purchase of transaction "+d.transactionID+", "+d.partnerTransactionID);TGS.Microtransactions._PartnerPurchaseSuccessful(d)}}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - onPurchased has no pending request")}};window.plugins.inAppPurchaseManager.onFailed=function(c,a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - failed: "+a);var b=TGS.Microtransactions._PendingRequest;if(b){b.internalErrorMessage=a;TGS.Microtransactions._PartnerPurchaseFailed(b)}};window.plugins.inAppPurchaseManager.onRestored=function(c,b,a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager WP8 - restored: "+b)};window.plugins.inAppPurchaseManager.canPurchase(this.userAllowsPurchase.bind(this))}this._mIsReady=true;if(this.onAdapterReady!==null){this.onAdapterReady.call()}TGS.Debug.Log(TGS.Debug.LOG_INFO,"Windows Phone WP8 adapter initialized.")},connect:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Windows Phone WP8 adapter connecting...");this.getLoginStatus()},onPurchaseSuccess:function(a){var d=this.currentWinApp.licenseInformation;if(d!=null){var c=d.productLicenses.lookup(a).isActive;TGS.Debug.Log(TGS.Debug.LOG_INFO,"Windows Phone purchase accepted for "+a);var b=TGS.Microtransactions._PendingRequest;if(b!=null){b.partnerTransactionID=a;TGS.Microtransactions._PartnerPurchaseSuccessful(b)}}},onPurchaseFailed:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Windows Phone purchase failed "+a);var b=TGS.Microtransactions._PendingRequest;if(b!=null){b.internalErrorMessage="Windows Phone status failed";TGS.Microtransactions._PartnerPurchaseFailed(b)}},onInAppPurchaseFailed:function(a,c){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - failed: "+c);var b=TGS.Microtransactions._PendingRequest;if(b!=null){b.internalErrorMessage=c;TGS.Microtransactions._PartnerPurchaseFailed(b)}},userAllowsPurchase:function(a){this._isPurchaseAllowed=a;TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchaseManager.canPurchase WP8: "+this._isPurchaseAllowed)},purchaseItem:function(b){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Windows Phone purchase request for "+b.item.id+" ("+b.item.partnerProductID+").");var a=b.item.partnerProductID;var c=1;if(a!=null&&a.length>0){window.plugins.inAppPurchaseManager.makePurchase(a,c)}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"Windows Phone purchase request cannot be fulfilled no product id specified");this.onPurchaseFailed(a)}},};extend(TGS.WindowsPhoneAdapter,TGS.PartnerBridge);TGS.JooistAdapter=function(){TGS.JooistAdapter.superclass.constructor.call(this);this._mJooistUserID=getQueryString()["user_id"];if(!this._mJooistUserID){this._mJooistUserID=30}this._mSessionID=null};TGS.JooistAdapter.prototype={supportsPersistentUser:function(){return true},supportsMicrotransactions:function(){return true},costFactor:function(){return 100},currencyIcon:function(){return TGS._IMAGES_LOCATION+"jooist.png"},priceAsFormattedString:function(a){return(a*this.costFactor()).toString()+" credits"},serverHandlesMicrotransactionResponse:function(){return true},supportsLeaderboard:function(){return true},connect:function(b){var a='{"game":"'+TGS._sGameID+'","jooist_user":"'+this._mJooistUserID+'"}';TGS.SendMessage("partner_bridges/jooist/bridge","session_start",a,this._onSessionStartSuccess.bind(this),this._onSessionStartFailure.bind(this))},_onSessionStartSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Jooist session start succeeded: "+a.session_id);this._mSessionID=a.session_id;if(this.onUserInfoAvailable!==null){this.onUserInfoAvailable.call(this,this._mJooistUserID)}},_onSessionStartFailure:function(b,a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist session start failed")},submitScore:function(c){var b=null;if(typeof(c.leaderboardID)==="undefined"){b=1}else{b=c.leaderboardID+1}var a='{"game":"'+TGS._sGameID+'","session_id":"'+this._mSessionID+'","leaderboard":"'+b+'","score":"'+c.score+'"}';TGS.SendMessage("partner_bridges/jooist/bridge","submit_score",a,this._onSubmitScoreSuccess.bind(this),this._onSubmitScoreFailure.bind(this))},_onSubmitScoreSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Jooist score submission succeeded")},_onSubmitScoreFailure:function(b,a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist score submission failed")},submitScoreAndShow:function(c){var b=null;if(typeof(c.leaderboardID)==="undefined"){b=1}else{b=c.leaderboardID+1}var a='{"game":"'+TGS._sGameID+'","session_id":"'+this._mSessionID+'","leaderboard":"'+b+'","score":"'+c.score+'"}';TGS.SendMessage("partner_bridges/jooist/bridge","submit_score",a,this._onSubmitScoreAndShowSuccess.bind(this),this._onSubmitScoreAndShowFailure.bind(this))},_onSubmitScoreAndShowSuccess:function(a){},_onSubmitScoreAndShowFailure:function(b,a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist score submission failed")},purchaseItem:function(b){var a='{"game":"'+TGS._sGameID+'","jooist_user":"'+this._mJooistUserID+'"}';TGS.SendMessage("partner_bridges/jooist/bridge","check_balance",a,this._onCheckBalanceSuccess.bind(this,b),this._onCheckBalanceFailure.bind(this,b))},_onCheckBalanceSuccess:function(c,b){var d=c.item.price*this.costFactor();if(b.credits>=d){var a='{"game":"'+TGS._sGameID+'","tresensa_transaction_id":"'+c.transactionID+'","user":"'+TGS._sUserID+'","jooist_user":"'+this._mJooistUserID+'","credits":"'+d+'","game_data_changes":'+JSON.stringify(c.gameDataUpdates)+"}";TGS.SendMessage("partner_bridges/jooist/bridge","purchase",a,this._onPurchaseSuccess.bind(this,c),this._onPurchaseFailure.bind(this,c))}else{c.internalErrorMessage="insufficient funds";c.userErrorMessage="You need "+(d-b.credits)+" additional credits to purchase this item.";TGS.Microtransactions._PartnerPurchaseFailed(c)}},_onCheckBalanceFailure:function(c,b,a){c.internalErrorMessage="Credit balance check failed";if(typeof(a.message)!=="undefined"){c.internalErrorMessage+=" - "+a.message}c.userErrorMessage="";TGS.Microtransactions._PartnerPurchaseFailed(c)},_onPurchaseSuccess:function(b,a){TGS.Microtransactions._PartnerPurchaseSuccessful(b)},_onPurchaseFailure:function(c,b,a){c.internalErrorMessage="Jooist purchase failed";if(typeof(a.message)!=="undefined"){c.internalErrorMessage+=" - "+a.message}c.userErrorMessage="";TGS.Microtransactions._PartnerPurchaseFailed(c)}};extend(TGS.JooistAdapter,TGS.PartnerBridge);TGS.DataStore=function(){};TGS.DataStore.onDataChanged=null;TGS.DataStore.GameData=null;TGS.DataStore._sSaveToTGSServer=true;TGS.DataStore._sSaveToLocalStorage=false;TGS.DataStore.ReloadGameData=function(h,d){if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return}if(!TGS._sPartnerID||!TGS._sGameID||!TGS._sUserID||!TGS._sPartnerBridge||!TGS._sPartnerBridge.isReady()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"TGS.DataStore.ReloadGameData - TGS is not ready yet");if(d){d.call(this,"TGS was not ready")}return}var f=TGS._sPartnerID;TGS.Debug.Log(TGS.Debug.LOG_INFO,"fetching complete game state...");var b=false;if(TGS.DataStore._sSaveToLocalStorage){var a=window.localStorage.getItem(TGS._sLSKeys.TGS_datastore);if(!a){a="{}";TGS.Debug.Log(TGS.Debug.LOG_INFO,"there was no local TGS.DataStore data");b=true}var c=TGS.DataStore.GameData=JSON.parse(a);if(h&&(!b||(b&&!TGS.DataStore._sSaveToTGSServer))){h.call(this,c);h=null;d=null}}if(TGS.DataStore._sSaveToTGSServer){var g='{"game":"'+TGS._sGameID+'","partner":"'+f+'","user":"'+TGS._sUserID+'","keys":[]}';var e=new TGS.DataStoreRequest();e.type="reload";e.onSuccess=h;e.onFailure=d;e.params=g;e.noLocalData=b;TGS.SendMessage("game_data","get",g,TGS.DataStore._SuccessCallback.bind(this,e),TGS.DataStore._ErrorCallback.bind(this,e))}};TGS.DataStore.ReloadData=function(f){if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return}if(!TGS._sPartnerID||!TGS._sGameID||!TGS._sUserID||!TGS._sPartnerBridge||!TGS._sPartnerBridge.isReady()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"TGS.DataStore.ReloadGameData - TGS is not ready yet");if(f.onFailure){f.onFailure.call(this,"TGS was not ready")}return}var e=TGS._sPartnerID;TGS.Debug.Log(TGS.Debug.LOG_INFO,"fetching complete game state ("+f.location+")...");if(f.location==="local"){var a=window.localStorage.getItem(TGS._sLSKeys.TGS_datastore);if(!a){a="{}";TGS.Debug.Log(TGS.Debug.LOG_INFO,"there was no local TGS.DataStore data")}var b=TGS.DataStore.GameData=JSON.parse(a);if(f.onSuccess){f.onSuccess.call(this,b)}return}if(f.location==="remote"){var c='{"game":"'+TGS._sGameID+'","partner":"'+e+'","user":"'+TGS._sUserID+'","keys":[]}';var d=new TGS.DataStoreRequest();d.type="reload";d.useLocalIfEmpty=f.useLocalIfEmpty;d.onSuccess=f.onSuccess;d.onFailure=f.onFailure;TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"requesting game data with params: "+c);TGS.SendMessage("game_data","get",c,TGS.DataStore._ReloadSuccessCallback.bind(this,d),TGS.DataStore._ErrorCallback.bind(this,d))}};TGS.DataStore._ReloadSuccessCallback=function(f,c){if(!c||typeof(c.code)==="undefined"){TGS.DataStore._ErrorCallback(f,"response object is malformed",c);return}else{if(c.code!==0){TGS.DataStore._ErrorCallback(f,"internal request error code: "+c.code,c);return}}TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"received game data: "+JSON.stringify(c.values));var d=c.values;if(Object.prototype.toString.call(d)==="[object Array]"){d={}}var b=true;for(var e in d){if(d.hasOwnProperty(e)){b=false;break}}if(b&&f.useLocalIfEmpty){TGS.Debug.Log(TGS.Debug.LOG_INFO,"there was no remote game data for this user, falling back to local storage...");var a=window.localStorage.getItem(TGS._sLSKeys.TGS_datastore);if(!a){a="{}"}d=JSON.parse(a);b=false}TGS.DataStore.GameData=d;if(b){window.localStorage.removeItem(TGS._sLSKeys.TGS_datastore)}else{var a=JSON.stringify(TGS.DataStore.GameData);window.localStorage.setItem(TGS._sLSKeys.TGS_datastore,a)}TGS.DataStore._DataUpdated();if(f.onSuccess){f.onSuccess.call(this,d)}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"remote DataStore request was successful")}};TGS.DataStore.ClearLocalData=function(){TGS.DataStore.GameData={};window.localStorage.removeItem(TGS._sLSKeys.TGS_datastore);TGS.DataStore._DataUpdated()};TGS.DataStore._DataUpdated=function(){if(window.TGE){var a=TGE.Game.GetInstance();if(a&&a._onTGSDatastoreUpdated){a._onTGSDatastoreUpdated()}}if(TGS.DataStore.onDataChanged){TGS.DataStore.onDataChanged.call(this)}};TGS.DataStore.ImportGameData=function(d,a,f,b){if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return}if(!TGS._sPartnerID||!TGS._sGameID||!TGS._sUserID||!TGS._sPartnerBridge||!TGS._sPartnerBridge.isReady()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"TGS.DataStore.ReloadGameData - TGS is not ready yet");if(b){b.call(this,"TGS was not ready")}return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"importing complete game state...");var e='{"game":"'+TGS._sGameID+'","partner":"'+d+'","user":"'+a+'","keys":[]}';var c=new TGS.DataStoreRequest();c.type="reload";c.onSuccess=f;c.onFailure=b;c.params=e;TGS.SendMessage("game_data","get",e,TGS.DataStore._SuccessCallback.bind(this,c),TGS.DataStore._ErrorCallback.bind(this,c))};TGS.DataStore._SuccessCallback=function(c,a){if(!a||typeof(a.code)==="undefined"){TGS.DataStore._ErrorCallback(c,"response object is malformed",a);return}else{if(a.code!==0){TGS.DataStore._ErrorCallback(c,"internal request error code: "+a.code,a);return}}if(!c.noLocalData&&TGS.DataStore._sSaveToLocalStorage){TGS.Debug.Log(TGS.Debug.LOG_INFO,"remote DataStore request was successful");return}var b=null;if(c.type==="reload"){b=a.values;if(Object.prototype.toString.call(b)==="[object Array]"){b={}}TGS.DataStore.GameData=b}if(c.onSuccess){c.onSuccess.call(this,b)}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"remote DataStore request was successful")}};TGS.DataStore._ErrorCallback=function(c,b,a){if(c.onFailure){c.onFailure.call(this,b,a)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"remote DataStore request failed: "+b)}};TGS.DataStore.FetchStringValue=function(b,a){if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return a}if(!TGS.IsReady()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"DataStore tried to fetch value '"+b+"' before TGS was ready");return a}if(typeof(TGS.DataStore.GameData[b])==="undefined"){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"no value stored for '"+b+"', using default");return a}return TGS.DataStore.GameData[b]};TGS.DataStore.FetchIntValue=function(b,a){return parseInt(TGS.DataStore.FetchStringValue(b,a))};TGS.DataStore.FetchFloatValue=function(b,a){return parseFloat(TGS.DataStore.FetchStringValue(b,a))};TGS.DataStore.SaveValue=function(b,e,h,c){if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return}if(!TGS.IsReady()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"DataStore tried to save value for '"+b+"' before TGS was ready");return}var f=TGS._sPartnerID;TGS.Debug.Log(TGS.Debug.LOG_INFO,"saving new value for '"+b+"' to datastore...");TGS.DataStore.GameData[b]=e.toString();if(TGS.DataStore._sSaveToLocalStorage){var a=JSON.stringify(TGS.DataStore.GameData);window.localStorage.setItem(TGS._sLSKeys.TGS_datastore,a);if(h){h.call(this,null)}}if(TGS.DataStore._sSaveToTGSServer){if(TGS.DataStore._sSaveToLocalStorage){h=null;c=null}var g='{"game":"'+TGS._sGameID+'","partner":"'+f+'","user":"'+TGS._sUserID+'","values":{"'+b+'":"'+e.toString()+'"}}';var d=new TGS.DataStoreRequest();d.type="save";d.onSuccess=h;d.onFailure=c;d.params=g;TGS.SendMessage("game_data","set",g,TGS.DataStore._SuccessCallback.bind(this,d),TGS.DataStore._ErrorCallback.bind(this,d))}TGS.DataStore._DataUpdated()};TGS.DataStore.SaveValues=function(h,g,c){if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return}if(!TGS.IsReady()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"DataStore tried to save values before TGS was ready");return}var e=TGS._sPartnerID;TGS.DataStore.SaveValuesLocally(h);if(TGS.DataStore._sSaveToLocalStorage){var a=JSON.stringify(TGS.DataStore.GameData);window.localStorage.setItem(TGS._sLSKeys.TGS_datastore,a);if(g){g.call(this,null)}}if(TGS.DataStore._sSaveToTGSServer){if(TGS.DataStore._sSaveToLocalStorage){g=null;c=null}var b='"values":'+JSON.stringify(h);TGS.Debug.Log(TGS.Debug.LOG_INFO,"saving new values to server "+b+"...");var f='{"game":"'+TGS._sGameID+'","partner":"'+e+'","user":"'+TGS._sUserID+'",'+b+"}";var d=new TGS.DataStoreRequest();d.type="save";d.onSuccess=g;d.onFailure=c;d.params=f;TGS.SendMessage("game_data","set",f,TGS.DataStore._SuccessCallback.bind(this,d),TGS.DataStore._ErrorCallback.bind(this,d))}};TGS.DataStore.SaveValuesLocally=function(d,c){c=typeof(c)==="undefined"?false:c;if(!TGS._sPartnerBridge.supportsDatastore()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"datastore operations are not available on this distribution partner");return}if(!TGS.IsReady()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"DataStore tried to save values before TGS was ready");return}for(var b in d){if(d.hasOwnProperty(b)){TGS.DataStore.GameData[b]=d[b].toString()}}if(c){var a=JSON.stringify(TGS.DataStore.GameData);window.localStorage.setItem(TGS._sLSKeys.TGS_datastore,a)}TGS.DataStore._DataUpdated()};TGS.DataStoreRequest=function(){this.type="";this.onSuccess=null;this.onFailure=null;this.noLocalData=false};TGS.Microtransactions=function(){};TGS.Microtransactions.DefaultPurchaseFailedMessage="The purchase was not completed.";TGS.Microtransactions.UseTGSErrorMessages=true;TGS.Microtransactions._PendingRequest=null;TGS.Microtransactions._PurchaseOverlay=null;TGS.Microtransactions._sIAPProducts=[];TGS.Microtransactions._sAppURLs=[];TGS.Microtransactions.PriceAsFormattedString=function(a){if(TGS._sPartnerBridge.supportsMicrotransactions()){return TGS._sPartnerBridge.priceAsFormattedString(a)}return""};TGS.Microtransactions.FormattedPriceForItem=function(a){if(TGS._sPartnerBridge.supportsMicrotransactions()){return TGS._sPartnerBridge.formattedPriceForItem(a)}return""};TGS.Microtransactions.CurrencyIcon=function(){if(TGS._sPartnerBridge.supportsMicrotransactions()){return TGS._sPartnerBridge.currencyIcon()}return null};TGS.Microtransactions.GetIAPProducts=function(){return TGS.Microtransactions._sIAPProducts};TGS.Microtransactions.GetIAPProduct=function(c){for(var b=0;b<TGS.Microtransactions._sIAPProducts.length;b++){var a=TGS.Microtransactions._sIAPProducts[b];if(a.id===c){return a}}return null};TGS.Microtransactions.PurchaseProduct=function(d){if(!TGS._sPartnerBridge.supportsMicrotransactions()){TGS.Microtransactions.RedirectToIAPPartner();return}if(TGS.Microtransactions._PendingRequest!==null){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"purchase request ignored - one is already pending");return}var a=true;var f="";if(typeof(d)!=="object"){a=false;f+="params "}else{if(typeof(d.productID)==="undefined"){a=false;f+="productID "}if(typeof(d.gameDataUpdates)!=="object"){a=false;f+="gameDataUpdates "}}if(!a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Invalid values sent to TGS.Microtransactions.PurchaseProduct for the following params: "+f);if(d&&d.onFailure){d.onFailure.call(this,d.productID,TGS.Microtransactions.DefaultPurchaseFailedMessage)}return}if(!TGS.LoggedIn()){TGS.LoginUser({onSuccess:TGS.Microtransactions.PurchaseProduct.bind(this,d),onUserCancel:TGS.OverlayMessage.bind(this,{title:"Login Required",message:"You must be logged in to make in-app purchases."}),onFailure:TGS.OverlayMessage.bind(this,{title:"Login Error",message:"There was a problem logging you in."})});return}var c=TGS.Microtransactions.GetIAPProduct(d.productID);var g=d.onFailure;if(TGS.Microtransactions.UseTGSErrorMessages){g=TGS.Microtransactions._PurchaseFailedMessage.bind(this,d.onFailure)}var j=d.productID;var h=d.onSuccess;var b=g;var i=d.gameDataUpdates;var k=new TGS.Microtransactions.Item(j,c.title,c.description,c.price,c.iconUrl,c.partnerProductID);if(!TGS.IsReady()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"tried to purchase product "+j+" but TGS was not ready");if(b){b.call(this,j,TGS.Microtransactions.DefaultPurchaseFailedMessage)}return}var e=new TGS.Microtransactions.Request();e.item=k;e.onSuccess=h;e.onFailure=b;e.userErrorMessage=TGS.Microtransactions.DefaultPurchaseFailedMessage;e.gameDataUpdates=i;TGS.Microtransactions._BeginNewRequest(e);if(TGS._sPartnerBridge.logTransactionBeforePartnerRequest()){TGS.Microtransactions._LogPurchaseRequest(e)}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"requesting purchase from partner...");TGS._sPartnerBridge.purchaseItem(e)}};TGS.Microtransactions.PurchaseItem=function(d){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"****** THE TGS.Microtransactions.PurchaseItem IAP CALL IS DEPRECATED! PLEASE UPDATE TO TGS.Microtransactions.PurchaseProduct INSTEAD!!");if(!TGS._sPartnerBridge.supportsMicrotransactions()){TGS.Microtransactions.RedirectToIAPPartner();return}if(TGS.Microtransactions._PendingRequest!==null){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"purchase request ignored - one is already pending");return}var a=true;var f="";if(typeof(d)!=="object"){a=false;f+="params "}else{if(typeof(d.itemID)!=="number"||d.itemID<0){a=false;f+="itemID "}if(typeof(d.title)!=="string"){a=false;f+="title "}if(typeof(d.description)!=="string"){a=false;f+="description "}if(typeof(d.price)!=="number"&&typeof(d.cost)!=="number"){a=false;f+="price "}if(typeof(d.image)!=="string"&&typeof(d.image)!=="Image"){a=false;f+="image "}if(typeof(d.gameDataUpdates)!=="object"){a=false;f+="gameDataUpdates "}}if(!a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Invalid values sent to TGS.Microtransactions.PurchaseItem for the following params: "+f);if(d&&d.onFailure){d.onFailure.call(this,d.itemID,TGS.Microtransactions.DefaultPurchaseFailedMessage)}return}if(!TGS.LoggedIn()){TGS.LoginUser({onSuccess:TGS.Microtransactions.PurchaseProduct.bind(this,d),onUserCancel:TGS.OverlayMessage.bind(this,{title:"Login Required",message:"You must be logged in to make in-app purchases."}),onFailure:TGS.OverlayMessage.bind(this,{title:"Login Error",message:"There was a problem logging you in."})});return}var h=d.onFailure;if(TGS.Microtransactions.UseTGSErrorMessages){h=TGS.Microtransactions._PurchaseFailedMessage.bind(this,d.onFailure)}var b=d.itemID;var i=d.onSuccess;var c=h;var j=d.gameDataUpdates;var g=d.price||d.cost;var k=new TGS.Microtransactions.Item(b,d.title,d.description,g,d.image,d.partnerProductID);if(!TGS.IsReady()){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"tried to purchase item "+b+" but TGS was not ready");if(c){c.call(this,b,TGS.Microtransactions.DefaultPurchaseFailedMessage)}return}var e=new TGS.Microtransactions.Request();e.item=k;e.onSuccess=i;e.onFailure=c;e.userErrorMessage=TGS.Microtransactions.DefaultPurchaseFailedMessage;e.gameDataUpdates=j;TGS.Microtransactions._BeginNewRequest(e);if(TGS._sPartnerBridge.logTransactionBeforePartnerRequest()){TGS.Microtransactions._LogPurchaseRequest(e)}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"requesting purchase from partner...");TGS._sPartnerBridge.purchaseItem(e)}};TGS.Microtransactions.RedirectToIAPPartner=function(){var d=null;var a=null;var c="In-app purchasing is not supported here.";var b=false;if(TGS.Microtransactions._sAppURLs.facebook_app_url){d=TGS.Microtransactions._sAppURLs.facebook_app_url;a=TGS._IMAGES_LOCATION+"redirects/facebook.png"}if(TGS.BrowserDetect.oniOS&&TGS.Microtransactions._sAppURLs.itunes_app_url){d=TGS.Microtransactions._sAppURLs.itunes_app_url;a=TGS._IMAGES_LOCATION+"redirects/itunes.png";var b=true}else{if(TGS.BrowserDetect.onAndroid&&TGS.Microtransactions._sAppURLs.googleplay_app_url){d=TGS.Microtransactions._sAppURLs.googleplay_app_url;a=TGS._IMAGES_LOCATION+"redirects/googleplay.png";var b=true}else{if(TGS.BrowserDetect.platform==="Kindle Fire"&&TGS.Microtransactions._sAppURLs.amazon_app_url){d=TGS.Microtransactions._sAppURLs.amazon_app_url;a=TGS._IMAGES_LOCATION+"redirects/amazon.png";var b=true}else{if(TGS.BrowserDetect.onWindowsMobile&&TGS.Microtransactions._sAppURLs.windows_app_url){d=TGS.Microtransactions._sAppURLs.windows_app_url;a=TGS._IMAGES_LOCATION+"redirects/windows.png";var b=true}}}}if(d){c+=" You can buy items by "+(b?"downloading the app:":"playing the game on:")}TGS.Debug.Log(TGS.Debug.LOG_INFO,"IAP is not available on this partner, suggesting redirect to "+d);TGS.OverlayMessage({title:"Sorry!",message:c,buttonText:"",button2Image:a,button2Callback:function(){window.open(d,"_blank")}})};TGS.Microtransactions._PurchaseFailedMessage=function(c,b,a){if(a.length>0){TGS.OverlayMessage({title:"Purchase Failed",message:a})}if(c){c.call(this,b,a)}};TGS.Microtransactions._LogPurchaseRequest=function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user request to purchase item "+a.item.id+"...");var b='{"game":"'+TGS._sGameID+'","partner":"'+TGS._sPartnerID+'","user":"'+TGS._sUserID+'","item":"'+a.item.id+'"}';TGS.SendMessage("mtx/mtx_data","add",b,TGS.Microtransactions._InitiatePurchase.bind(this,a),TGS.Microtransactions._LoggingPurchaseFailed.bind(this,a))};TGS.Microtransactions._InitiatePurchase=function(b,a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"purchase request id received: "+JSON.stringify(a));if(!a||typeof(a.code)==="undefined"){TGS.Debug.Log(TGS.Debug.LOG_INFO,"purchase request response was corrupt");TGS.Microtransactions._LoggingPurchaseFailed(b);return}if(a.code!==0){TGS.Debug.Log(TGS.Debug.LOG_INFO,"purchase request response contained error code: "+a.code);TGS.Microtransactions._LoggingPurchaseFailed(b);return}var c=parseInt(a.id);if(isNaN(c)||c<=0){TGS.Debug.Log(TGS.Debug.LOG_INFO,"transaction id is invalid: "+c.toString());TGS.Microtransactions._LoggingPurchaseFailed(b);return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"transaction id is: "+c);b.transactionID=c;TGS.Debug.Log(TGS.Debug.LOG_INFO,"requesting purchase from partner...");TGS._sPartnerBridge.purchaseItem(b)};TGS.Microtransactions._LoggingPurchaseFailed=function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not record IAP request");if(a.onFailure){a.onFailure.call(this,a.item.id,TGS.Microtransactions.DefaultPurchaseFailedMessage)}TGS.Microtransactions._ClosePendingRequest()};TGS.Microtransactions._PartnerPurchaseSuccessful=function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"purchase successful for item "+a.item.id);TGS.Microtransactions._SavePurchaseLocally(a.gameDataUpdates);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"local game data has now been updated");if(TGS._sPartnerBridge.serverHandlesMicrotransactionResponse()){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"server has already logged transaction");if(a.onSuccess){a.onSuccess.call(this,a.item.id)}}else{if(TGS._sPartnerBridge.logTransactionBeforePartnerRequest()){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending transaction response and game data updates to server...");var b='{"id":'+a.transactionID+',"state":1,"partner_transaction_id":"'+a.partnerTransactionID+'","notes":null,"game_data_changes":'+JSON.stringify(a.gameDataUpdates)+"}";TGS.SendMessage("mtx/mtx_data","update",b,TGS.Microtransactions._TransactionFinalized.bind(this,a,true),TGS.Microtransactions._FinalizationFailed.bind(this,a,true))}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending full transaction info to server...");var b='{"game":"'+TGS._sGameID+'","partner":"'+TGS._sPartnerID+'","user":"'+TGS._sUserID+'","item":"'+a.item.id+'","state":1,"partner_transaction_id":"'+a.partnerTransactionID+'","notes":null,"game_data_changes":'+JSON.stringify(a.gameDataUpdates)+"}";TGS.SendMessage("mtx/mtx_data","add",b,TGS.Microtransactions._TransactionFinalized.bind(this,a,true),TGS.Microtransactions._FinalizationFailed.bind(this,a,true))}}TGS.Microtransactions._ClosePendingRequest();TGS._sPartnerBridge.purchaseComplete(a)};TGS.Microtransactions._PartnerPurchaseFailed=function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"purchase failed for item "+a.item.id+", reason: "+a.internalErrorMessage);if(TGS._sPartnerBridge.serverHandlesMicrotransactionResponse()){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"server has already logged transaction");if(a.onFailure){a.onFailure.call(this,a.item.id,a.userErrorMessage)}}else{if(TGS._sPartnerBridge.logTransactionBeforePartnerRequest()){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending transaction response to server...");var b='{"id":'+a.transactionID+',"state":2,"partner_transaction_id":"'+a.partnerTransactionID+'","notes":"'+a.internalErrorMessage+'","game_data_changes":null}';TGS.SendMessage("mtx/mtx_data","update",b,TGS.Microtransactions._TransactionFinalized.bind(this,a,false),TGS.Microtransactions._FinalizationFailed.bind(this,a,false))}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending full transaction info to server...");var b='{"game":"'+TGS._sGameID+'","partner":"'+TGS._sPartnerID+'","user":"'+TGS._sUserID+'","item":"'+a.item.id+'","state":2,"partner_transaction_id":"'+a.partnerTransactionID+'","notes":"'+a.internalErrorMessage+'","game_data_changes":null}';TGS.SendMessage("mtx/mtx_data","add",b,TGS.Microtransactions._TransactionFinalized.bind(this,a,false),TGS.Microtransactions._FinalizationFailed.bind(this,a,false))}}TGS.Microtransactions._ClosePendingRequest()};TGS.Microtransactions._TransactionFinalized=function(a,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,(b?"successful":"failed")+" transaction "+a.transactionID+" has been logged");if(b&&a.onSuccess){a.onSuccess.call(this,a.item.id)}else{if(!b&&a.onFailure){a.onFailure.call(this,a.item.id,a.userErrorMessage)}}};TGS.Microtransactions._SavePurchaseLocally=function(a){TGS.DataStore.SaveValuesLocally(a,TGS.DataStore._sSaveToLocalStorage)};TGS.Microtransactions._FinalizationFailed=function(b,c){TGS.Debug.Log(TGS.Debug.LOG_ERROR,(c?"successful":"failed")+" transaction "+b.transactionID+" could not be logged");if(c){b.internalErrorMessage="partner transaction was successful but could not be logged to server"}if(b.onFailure){var a=b.userErrorMessage===""?TGS.Microtransactions.DefaultPurchaseFailedMessage:b.userErrorMessage;b.onFailure.call(this,b.item.id,a)}};TGS.Microtransactions._BeginNewRequest=function(a){TGS.Microtransactions._PendingRequest=a;TGS.Microtransactions._PurchaseOverlay=TGS.Microtransactions._ShowOverlay({})};TGS.Microtransactions._ClosePendingRequest=function(){TGS.Microtransactions._PendingRequest=null;TGS.Microtransactions._PurchaseOverlay.parentNode.removeChild(TGS.Microtransactions._PurchaseOverlay);TGS.Microtransactions._PurchaseOverlay=null};TGS.Microtransactions._ShowOverlay=function(g){var c=typeof g.overlayRed==="undefined"?TGS.OverlayRed:g.overlayRed;var b=typeof g.overlayGreen==="undefined"?TGS.OverlayGreen:g.overlayGreen;var h=typeof g.overlayBlue==="undefined"?TGS.OverlayBlue:g.overlayBlue;var e=typeof g.overlayOpacity==="undefined"?TGS.OverlayOpacity:g.overlayOpacity;var d=document.createElement("div");d.id="overlay";d.style.zIndex=10;d.style.position="fixed";d.style.width="100%";d.style.height="100%";d.style.top=0;d.style.left=0;d.style.backgroundColor="rgba("+Math.round(c*255).toString()+","+Math.round(b*255).toString()+","+Math.round(h*255).toString()+","+e.toString()+")";if(document.body.firstChild){document.body.insertBefore(d,document.body.firstChild)}else{document.body.appendChild(d)}var a=document.createElement("img");a.id="gif";a.src=TGS._IMAGES_LOCATION+"processing.gif";var f=window.innerHeight*0.45;a.style.display="block";a.style.marginLeft="auto";a.style.marginRight="auto";a.style.marginTop=f.toString()+"px";a.style.align="center";d.insertBefore(a,d.firstChild);d.addEventListener("click",TGS._BlockEvent,false);d.addEventListener("mousedown",TGS._BlockEvent,false);d.addEventListener("mouseup",TGS._BlockEvent,false);d.addEventListener("mousemove",TGS._BlockEvent,false);d.addEventListener("touchstart",TGS._BlockEvent,false);return d};TGS.Microtransactions.Item=function(d,f,b,a,c,e){this.id=d;this.partnerProductID=e;this.title=f;this.description=b;this.price=a;this.image=c};TGS.Microtransactions.Request=function(){this.item=null;this.partnerProductID="";this.transactionID=-1;this.partnerTransactionID=-1;this.onSuccess=null;this.onFailure=null;this.internalErrorMessage="";this.userErrorMessage="";this.gameDataUpdates=null};TGS.BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"an unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.platform=this.searchString(this.dataPlatform)||"an unknown OS or Device";this.OSversion=this.detectOSversion(this.platform);this.isMobileDevice=!(this.platform==="Windows"||this.platform==="Mac"||this.platform==="Linux");this.oniOS=this.platform==="iPhone"||this.platform==="iPad";this.onAndroid=this.platform==="Android";this.onWindowsMobile=this.platform==="Windows Phone"||this.platform==="Windows Tablet";this.usingPhoneGap=(window.PhoneGap||window.cordova||window.Cordova)},detectOSversion:function(b){var e="-1";var d="";var a=navigator.userAgent.toString();switch(b){case"Windows Phone":d=/Windows Phone OS\s+[\d\.]+/;e=String(a.match(d)).substring(17,20);break;case"iPhone":case"iPad":d=/OS\s+[\d\_]+/;e=String(a.match(d)).substring(3,6);break;case"Windows":d=/Windows NT\s+[\d\.]+/;var c=String(a.match(d)).substring(11,14);if(c=="6.1"){e="7"}else{if(c=="5.1"){e="XP"}else{if(c=="5.2"){e="XP"}else{if(c=="6.0"){e="Vista"}else{if(c=="5.01"){e="2000 SP1"}else{if(c=="5.0"){e="2000"}}}}}}break;case"Mac":d=/Mac OS X\s+[\d\_]+/;e=String(a.match(d)).substring(9,13);break;case"Android":d=/ndroid\s+[\d\.]+/;e=String(a.match(d)).substring(7,10);break}return e},searchString:function(d){for(var a=0;a<d.length;a++){if(d[a]!=null){var b=d[a].string;var c=d[a].prop;this.versionSearchString=d[a].versionSearch||d[a].identity;if(b){if(b.indexOf(d[a].subString)!==-1){return d[a].identity}}else{if(c){return d[a].identity}}}}},searchVersion:function(b){var a=b.indexOf(this.versionSearchString);if(a===-1){return}return parseFloat(b.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Explorer",identity:"Explorer",versionSearch:"Explorer"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{prop:window.opera,identity:"Opera"},{string:navigator.userAgent,subString:"Silk",identity:"Silk",versionSearch:"Silk"},{string:navigator.userAgent,subString:"Kindle Fire",identity:"Amazon Web App",versionSearch:"AppleWebKit"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.vendor,subString:"BlackBerry",identity:"BlackBerry"}],dataPlatform:[{string:navigator.userAgent,subString:"Windows Phone",identity:"Windows Phone"},{string:navigator.userAgent,subString:"Tablet PC",identity:"Windows Tablet"},{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone"},{string:navigator.userAgent,subString:"iPad",identity:"iPad"},{string:navigator.userAgent,subString:"iPod",identity:"iPod"},{string:navigator.userAgent,subString:"Silk",identity:"Kindle Fire"},{string:navigator.userAgent,subString:"Kindle Fire",identity:"Kindle Fire"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"Mobile",identity:"Mobile"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};TGS.BrowserDetect.init();TGS.Leaderboard=function(){};TGS.Leaderboard._sLeaderboardDescriptors=[];TGS.Leaderboard.UseTGSErrorMessages=true;TGS.Leaderboard.RequestUserLocation=true;TGS.Leaderboard.GetLeaderboardDescriptors=function(){return TGS.Leaderboard._sLeaderboardDescriptors};TGS.Leaderboard.GetLeaderboardDescriptor=function(a){for(var c=0;c<TGS.Leaderboard._sLeaderboardDescriptors.length;c++){var b=TGS.Leaderboard._sLeaderboardDescriptors[c];if(b.id===a){return b}}return null};TGS.Leaderboard.ScoreFormatter=function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};TGS.Leaderboard.Show=function(a){if(TGS._sPartnerBridge.supportsLeaderboard()){TGS._sPartnerBridge.showLeaderboard(a)}else{if(!TGS.LoggedIn()){TGS.LoginUser({onSuccess:TGS.Leaderboard._ShowSLB.bind(this,a),onUserCancel:TGS.OverlayMessage.bind(this,{title:"Login Required",message:"You must be logged in to use the leaderboard."}),onFailure:TGS.OverlayMessage.bind(this,{title:"Login Error",message:"There was a problem logging you in."})})}else{TGS.Leaderboard._ShowSLB(a)}}};TGS.Leaderboard.SubmitScore=function(a){if(TGS._sPartnerBridge.supportsLeaderboard()){TGS._sPartnerBridge.submitScore(a)}else{if(TGS.LoggedIn()){TGS.Leaderboard._SubmitScoreSLB(a)}else{TGS.Debug.Log(TGS.Debug.LOG_WARNING,"user is not logged in/authorized - silent score submit ignored")}}};TGS.Leaderboard.SubmitScoreAndShow=function(a){if(TGS._sPartnerBridge.supportsLeaderboard()){TGS._sPartnerBridge.submitScoreAndShow(a)}else{if(!TGS.LoggedIn()){TGS.LoginUser({onSuccess:TGS.Leaderboard._SubmitScoreAndShowSLB.bind(this,a),onUserCancel:TGS.OverlayMessage.bind(this,{title:"Login Required",message:"You must be logged in to use the leaderboard."}),onFailure:TGS.OverlayMessage.bind(this,{title:"Login Error",message:"There was a problem logging you in."})})}else{TGS.Leaderboard._SubmitScoreAndShowSLB(a)}}};TGS.Leaderboard._ShowSLB=function(e,a){if(!TGS._sPartnerBridge.loggedIntoFacebook()){TGS._sPartnerBridge.loginToFacebook(TGS._sPartnerBridge.promptForFacebookAuthorization.bind(TGS._sPartnerBridge),TGS.Leaderboard._ShowSLB.bind(this,e));return}a=typeof(a)==="undefined"?TGS._sPartnerBridge._mFacebookUserID:a;e.leaderboardID=typeof(e.leaderboardID)==="number"?e.leaderboardID:0;e.timePeriod=typeof(e.timePeriod)==="string"?e.timePeriod:"day";e.page=typeof(e.page)==="number"?e.page:1;e.gameCanvas=typeof(e.gameCanvas)==="object"?e.gameCanvas:null;e.showAd=typeof(e.showAd)==="boolean"?e.showAd:false;if(e.gameCanvas===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Invalid value sent to TGS.Leaderboard.SubmitScore for gameCanvas.");return}var b=typeof(e.onFailure)==="function"?e.onFailure:null;var d='{"game":"'+TGS._sGameID+'","partner":"A0003","leaderboard":"'+e.leaderboardID+'","user":"'+a+'","period":"'+e.timePeriod+'","page":'+e.page+"}";var c=new TGS.LeaderboardRequest();c.type="get";c.params=e;c.onSuccess=TGS.Leaderboard._PopulateLeaderboard.bind(this);c.onFailure=TGS.Leaderboard._RetrieveScoresFailed.bind(this,b);c.slbDivs=TGS.Leaderboard._OpenEmptyLeaderboard(c);TGS.SendMessage("leaderboard/score","get",d,TGS.Leaderboard._SuccessCallback.bind(this,c),TGS.Leaderboard._ErrorCallback.bind(this,c))};TGS.Leaderboard._SubmitScoreSLB=function(h,a){if(!TGS._sPartnerBridge.loggedIntoFacebook()){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"user is not logged in/authorized on Facebook - silent score submit ignored");return}if(typeof(h._fakeuser)!=="undefined"){a=h._fakeuser}a=typeof(a)==="undefined"?TGS._sPartnerBridge._mFacebookUserID:a;var g=true;var c="";if(typeof(h)!=="object"){g=false;c+="params "}else{if(typeof(h.score)!=="number"){g=false;c+="score "}}if(!g){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Invalid values sent to TGS.Leaderboard.SubmitScore for the following params: "+c);if(h&&h.onFailure){h.onFailure.call(this,h.score,h.leaderboardID)}return}h.leaderboardID=typeof(h.leaderboardID)==="number"?h.leaderboardID:0;var d=typeof(h.onFailure)==="function"?h.onFailure:null;var b=TGS._sPartnerBridge._mFacebookAccessToken?('"'+TGS._sPartnerBridge._mFacebookAccessToken+'"'):"null";var f='{"game":"'+TGS._sGameID+'","partner":"A0003","leaderboard":"'+h.leaderboardID+'","user":"'+a+'","score":"'+h.score+'","facebook_access_token":'+b+"}";TGS.Debug.Log(TGS.Debug.LOG_INFO,"MESSAGE: "+f);var e=new TGS.LeaderboardRequest();e.type="add";e.params=h;e.onSuccess=h.onSuccess;e.onFailure=d;TGS.Debug.Log(TGS.Debug.LOG_INFO,"submitting new score of "+h.score+" to server...");TGS.SendMessage("leaderboard/score","add",f,TGS.Leaderboard._SuccessCallback.bind(this,e),TGS.Leaderboard._ErrorCallback.bind(this,e))};TGS.Leaderboard._SubmitScoreAndShowSLB=function(g,a){if(!TGS._sPartnerBridge.loggedIntoFacebook()){TGS._sPartnerBridge.loginToFacebook(TGS._sPartnerBridge.promptForFacebookAuthorization.bind(TGS._sPartnerBridge),TGS.Leaderboard._SubmitScoreAndShowSLB.bind(this,g));return}a=typeof(a)==="undefined"?TGS._sPartnerBridge._mFacebookUserID:a;var f=true;var b="";if(typeof(g)!=="object"){f=false;b+="params "}else{if(typeof(g.score)!=="number"){f=false;b+="score "}}if(!f){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Invalid values sent to TGS.Leaderboard.SubmitScoreAndShow for the following params: "+b);if(g&&g.onFailure){g.onFailure.call(this,g.score,g.leaderboardID)}return}g.leaderboardID=typeof(g.leaderboardID)==="number"?g.leaderboardID:0;g.timePeriod=typeof(g.timePeriod)==="string"?g.timePeriod:"day";g.page=typeof(g.page)==="number"?g.page:1;g.gameCanvas=typeof(g.gameCanvas)==="object"?g.gameCanvas:null;g.showAd=typeof(g.showAd)==="boolean"?g.showAd:false;if(g.gameCanvas===null){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Invalid value sent to TGS.Leaderboard.SubmitScoreAndShow for gameCanvas.");return}var c=typeof(g.onFailure)==="function"?g.onFailure:null;var e='{"game":"'+TGS._sGameID+'","partner":"A0003","leaderboard":"'+g.leaderboardID+'","user":"'+a+'","score":"'+g.score+'","period":"'+g.timePeriod+'","page":'+g.page+',"facebook_access_token":"'+TGS._sPartnerBridge._mFacebookAccessToken+'"}';var d=new TGS.LeaderboardRequest();d.type="add";d.params=g;d.onSuccess=TGS.Leaderboard._PopulateLeaderboard.bind(this);d.onFailure=TGS.Leaderboard._RetrieveScoresFailed.bind(this,c);d.slbDivs=TGS.Leaderboard._OpenEmptyLeaderboard(d);TGS.Debug.Log(TGS.Debug.LOG_INFO,"submitting new score of "+g.score+" to server...");TGS.SendMessage("leaderboard/score","add",e,TGS.Leaderboard._SuccessCallback.bind(this,d),TGS.Leaderboard._ErrorCallback.bind(this,d))};TGS.Leaderboard._OpenEmptyLeaderboard=function(d){var a=d.params.gameCanvas;var e={};e.titleText="";switch(d.params.timePeriod){case"day":e.titleText="Daily";break;case"week":e.titleText="Weekly";break;case"all":e.titleText="All-Time"}e.social_leaderboard=document.createElement("div");e.social_leaderboard.id="social_leaderboard";a.insertBefore(e.social_leaderboard,a.firstChild);e.social_leaderboard.addEventListener("click",TGS.Leaderboard._BlockEvent,false);e.social_leaderboard.addEventListener("mousedown",TGS.Leaderboard._BlockEvent,false);e.social_leaderboard.addEventListener("mouseup",TGS.Leaderboard._BlockEvent,false);e.social_leaderboard.addEventListener("mousemove",TGS.Leaderboard._BlockEvent,false);e.social_leaderboard.addEventListener("touchstart",TGS.Leaderboard._BlockEvent,false);e.social_leaderboard_relative_container=document.createElement("div");e.social_leaderboard_relative_container.id="social_leaderboard_relative_container";e.social_leaderboard.appendChild(e.social_leaderboard_relative_container);var c={};c.closeCallback=null;c.slbActionOne=null;c.slbActionTwo=null;if(d.params&&d.params.onClose){c.closeCallback=d.params.onClose}if(d.params&&d.params.onAction1){c.slbActionOne=d.params.onAction1}else{c.slbActionOne=TGS.Leaderboard._FacebookChallenge.bind(this,d.params.score)}if(d.params&&d.params.onAction2){c.slbActionTwo=d.params.onAction2}e=TGS.Leaderboard._CreateMiscDivs(e,c,d.params.showAd);e=TGS.Leaderboard._CreateRankDivs(e);e=TGS.Leaderboard._CreateSLBContainer(e);if(d.params&&d.params.onShow){d.params.onShow.call()}var f=d.params.imageOverrides;if(typeof(f)!=="undefined"){for(var b in f){if(f.hasOwnProperty(b)&&document.getElementById(b)){document.getElementById(b).style.backgroundImage="url("+f[b]+")"}}}return e};TGS.Leaderboard._CreateMiscDivs=function(d,b,c){var a=!TGS.BrowserDetect.isMobileDevice||TGS.BrowserDetect.onWindowsMobile?"click":"touchstart";d.tgslb_close_button=document.createElement("a");d.tgslb_close_button.id="tgslb_close_button";d.tgslb_close_button.addEventListener(a,TGS.Leaderboard._CloseLeaderboard.bind(this,d.social_leaderboard,b.closeCallback));d.tgslb_action_button1=document.createElement("a");d.tgslb_action_button1.id="tgslb_action_button1";d.tgslb_action_button1.addEventListener(a,TGS.Leaderboard._FireCustomAction.bind(this,b.slbActionOne));d.tgslb_action_button2=document.createElement("a");d.tgslb_action_button2.id="tgslb_action_button2";d.tgslb_action_button2.addEventListener(a,TGS.Leaderboard._FireCustomAction.bind(this,b.slbActionTwo));c=(c&&TGS.Leaderboard._AdsAllowed());d.tgslb_ad=document.createElement(c?"div":"a");d.tgslb_ad.id=c?"tgslb_ad":"tgslb_no_ad";if(c){d.tgslb_ad.innerHTML="<object type='text/html' width='"+300+"' height='"+250+"' data='"+GameConfig.ADSERVER_GAMEOVER_URL+"'></object>"}else{d.tgslb_ad.addEventListener(a,TGS.Leaderboard._FireCustomAction.bind(this,null))}d.social_leaderboard_relative_container.appendChild(d.tgslb_close_button);d.social_leaderboard_relative_container.appendChild(d.tgslb_action_button1);d.social_leaderboard_relative_container.appendChild(d.tgslb_action_button2);d.social_leaderboard_relative_container.appendChild(d.tgslb_ad);return d};TGS.Leaderboard._AdsAllowed=function(){return TGS._sPartnerBridge.adsAllowed()};TGS.Leaderboard._CreateRankDivs=function(a){a.tgslb_rank_container=document.createElement("div");a.tgslb_rank_container.id="tgslb_rank_container";a.tgslb_rank_relative_container=document.createElement("div");a.tgslb_rank_relative_container.id="tgslb_rank_relative_container";a.tgslb_rank_loading=document.createElement("div");a.tgslb_rank_loading.id="tgslb_rank_loading";a.tgslb_rank_title=document.createElement("div");a.tgslb_rank_title.id="tgslb_rank_title";a.tgslb_rank_title.innerHTML="<span>Your "+a.titleText+" Rank</span>";a.tgslb_rank_relative_container.appendChild(a.tgslb_rank_title);a.tgslb_rank_relative_container.appendChild(a.tgslb_rank_loading);a.tgslb_rank_container.appendChild(a.tgslb_rank_relative_container);a.social_leaderboard_relative_container.appendChild(a.tgslb_rank_container);return a};TGS.Leaderboard._CreateSLBContainer=function(a){a.tgslb_leaderboard_container=document.createElement("div");a.tgslb_leaderboard_container.id="tgslb_leaderboard_container";a.tgslb_leaderboard_relative_container=document.createElement("div");a.tgslb_leaderboard_relative_container.id="tgslb_leaderboard_relative_container";a.tgslb_leaderboard_title=document.createElement("div");a.tgslb_leaderboard_title.id="tgslb_leaderboard_title";a.tgslb_leaderboard_title.innerHTML="<span>"+a.titleText+" Leaders</span>";a.tgslb_leaderboard_scroll_container=document.createElement("div");a.tgslb_leaderboard_scroll_container.id="tgslb_leaderboard_scroll_container";a.tgslb_leaderboard=document.createElement("table");a.tgslb_leaderboard.id="tgslb_leaderboard";a.tgslb_table_loading=document.createElement("div");a.tgslb_table_loading.id="tgslb_table_loading";a.tgslb_leaderboard_scroll_container.appendChild(a.tgslb_leaderboard);a.tgslb_leaderboard_relative_container.appendChild(a.tgslb_leaderboard_title);a.tgslb_leaderboard_relative_container.appendChild(a.tgslb_leaderboard_scroll_container);a.tgslb_leaderboard_relative_container.appendChild(a.tgslb_table_loading);a.tgslb_leaderboard_container.appendChild(a.tgslb_leaderboard_relative_container);a.social_leaderboard_relative_container.appendChild(a.tgslb_leaderboard_container);return a};TGS.Leaderboard._PopulateLeaderboard=function(f,b){var e=b.scores;var d=f.slbDivs;d.tgslb_rank_loading.parentNode.removeChild(d.tgslb_rank_loading);d.tgslb_table_loading.parentNode.removeChild(d.tgslb_table_loading);for(var c=0;c<e.length;c++){d.tgslb_leaderboard.appendChild(TGS.Leaderboard._CreateRowFromUser(c,e[c]))}d.tgslb_rank_container.removeChild(d.tgslb_rank_relative_container);d.tgslb_rank_container.appendChild(TGS.Leaderboard._CreateUserRankRelative(b,d.titleText));if(TGS.BrowserDetect.isMobileDevice){var a=new iScroll("tgslb_leaderboard_scroll_container")}if(typeof(_gaq)!=="undefined"&&typeof(window.GameConfig)!=="undefined"&&typeof(window.GameConfig.PATH)==="string"){_gaq.push(["_trackPageview",GameConfig.PATH+"leaderboard"])}};TGS.Leaderboard._CreateUserRankRelative=function(c,n){var f=typeof(c.rank)==="number"?c.rank.toString():"";var b=typeof(c.displayName)==="string"?c.displayName:"";var e=typeof(c.avatarUrlSSL)==="string"?c.avatarUrlSSL:"";var d=typeof(c.highScore)==="number"?c.highScore:"";var j=typeof(c.location)==="string"?c.location:"";var g=document.createElement("div");g.id="tgslb_rank_title";g.innerHTML="<span>Your "+n+" Rank</span>";var h=document.createElement("div");h.id="tgslb_rank_value";h.innerHTML="<span>"+f+"</span>";var m=document.createElement("img");m.id="tgslb_rank_image";m.setAttribute("src",e);var i=document.createElement("div");i.id="tgslb_rank_name";i.innerHTML="<span>"+b+"</span>";var k=document.createElement("div");k.id="tgslb_rank_location";k.innerHTML="<span>"+j+"</span>";var l=document.createElement("div");l.id="tgslb_rank_score";l.innerHTML="<span>"+TGS.Leaderboard.ScoreFormatter(d)+"</span>";var a=document.createElement("div");a.id="tgslb_rank_relative_container";a.appendChild(g);a.appendChild(h);a.appendChild(m);a.appendChild(i);a.appendChild(k);a.appendChild(l);return a};TGS.Leaderboard._CreateRowFromUser=function(e,f){var b=document.createElement("tr");var l=document.createElement("td");l.id="tgslb_leaderboard_row"+(e+1);if(e%2==1){l.className="tgslb_leaderboard_alternate_row"}var k=document.createElement("div");k.className="tgslb_leaderboard_row_relative_container";var a=document.createElement("div");a.className="tgslb_leaderboard_row_position";a.innerHTML="<span>"+(e+1)+"</span>";var i=document.createElement("img");i.className="tgslb_leaderboard_row_image";i.setAttribute("src",f.playerInfo.avatarUrlSSL);var h=document.createElement("div");h.className="tgslb_leaderboard_row_name";h.innerHTML="<span>"+f.playerInfo.displayName+"</span>";var g=document.createElement("div");g.className="tgslb_leaderboard_row_location";var j=typeof(f.playerInfo.location)==="string"?f.playerInfo.location:"";g.innerHTML="<span>"+j+"</span>";var c=document.createElement("div");c.className="tgslb_leaderboard_row_score";c.innerHTML="<span>"+TGS.Leaderboard.ScoreFormatter(f.score)+"</span>";var d=document.createElement("div");d.className="tgslb_leaderboard_row_border";k.appendChild(a);k.appendChild(i);k.appendChild(h);k.appendChild(g);k.appendChild(c);k.appendChild(d);l.appendChild(k);b.appendChild(l);return b};TGS.Leaderboard._FacebookChallenge=function(d){var c=(typeof(window.GameConfig)!=="undefined"&&typeof(window.GameConfig.TITLE)==="string")?window.GameConfig.TITLE:null;var b=c?c:"Check out this game!";var a="See if you can beat me in this awesome game"+(c?(" called "+c):"")+".";if(typeof(d)!=="undefined"){a+=" I just scored "+TGS.Leaderboard.ScoreFormatter(d)+"."}var e="popup";if(TGS.BrowserDetect.isMobileDevice){e="touch"}if(typeof(_gaq)!=="undefined"){_gaq.push(["_trackSocial","facebook","request dialog"])}FB.ui({show_error:true,display:e,method:"apprequests",title:b,message:a},function(f){if(f&&typeof(_gaq)!=="undefined"){_gaq.push(["_trackSocial","facebook","request sent"])}})};TGS.Leaderboard._CloseLeaderboard=function(a,c,b){a.parentNode.removeChild(a);if(c!==null){c.call()}};TGS.Leaderboard._FireCustomAction=function(a,b){if(a!==null){a.call()}};TGS.Leaderboard._BlockEvent=function(a){a.stopPropagation();a.preventDefault();a.stopImmediatePropagation();return false};TGS.Leaderboard._SuccessCallback=function(b,a){if(!a||typeof(a.code)==="undefined"){TGS.Leaderboard._ErrorCallback(b,"response object is malformed",a);return}else{if(a.code!==0){TGS.Leaderboard._ErrorCallback(b,"internal request error code: "+a.code,a);return}}if(b.onSuccess){b.onSuccess.call(this,b,a)}else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"Leaderboard "+b.type+" request was successful")}};TGS.Leaderboard._ErrorCallback=function(c,b,a){if(c.onFailure){c.onFailure.call(this,b,a)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Leaderboard "+c.type+" request failed: "+b)}};TGS.Leaderboard._RetrieveScoresFailed=function(c,b,a){if(b.length>0){TGS.OverlayMessage({title:"Leaderboard Error",message:b})}if(c){c.call(this,b,a)}if(typeof(window.TGE)!=="undefined"&&typeof(TGE.Game.prototype.AnalyticErrorEvent)!=="undefined"&&TGE.Game.GetInstance()!==null){TGE.Game.GetInstance().AnalyticErrorEvent("leaderboard unavailable")}};TGS.LeaderboardRequest=function(){this.type="";this.params=null;this.onSuccess=null;this.onFailure=null};var hostLocation="stg-tgs.tresensa.com";if(typeof(window.GameConfig)!=="undefined"&&GameConfig.TGS&&GameConfig.TGS.HOST){hostLocation=GameConfig.TGS.HOST}var serverLocation=hostLocation+"/server/";serverLocation+="0.3.6/";TGS._SERVER_LOCATION=(document.location.protocol==="https:"?"https:":"http:")+"//"+serverLocation;TGS._IMAGES_LOCATION=(document.location.protocol==="https:"?"https:":"http:")+"//static.tresensa.com/tgs/images/";TGS._sOn=false;TGS._sFakeConnections=false;TGS._sPartnerID=null;TGS._sGameID=null;TGS._sUserID=null;TGS._sPartnerBridge=null;TGS._sGamePartnerInfo=null;TGS._sContinueOnPartnerInfoFail=false;TGS._sLSKeys={};TGS._sOnline=true;TGS.OverlayRed=0.6;TGS.OverlayGreen=0.6;TGS.OverlayBlue=0.6;TGS.OverlayOpacity=0.6;TGS.onReady=null;TGS.onUserChanged=null;TGS.Debug=TGS.Debug||{};TGS.Debug.LOG_NONE=0;TGS.Debug.LOG_ERROR=1;TGS.Debug.LOG_WARNING=2;TGS.Debug.LOG_INFO=3;TGS.Debug.LOG_VERBOSE=4;if(typeof(GameConfig)!=="undefined"&&typeof GameConfig.LOG_LEVEL==="number"){TGS.Debug.LogLevel=GameConfig.LOG_LEVEL}else{TGS.Debug.LogLevel=TGS.Debug.LOG_INFO}TGS.Debug.Log=function(b){if(window.console&&b<=TGS.Debug.LogLevel){var a="TGS: ";if(b===TGS.Debug.LOG_ERROR){a+="**ERROR** "}window.console.log(a+Array.prototype.slice.call(arguments,1))}};TGS.UseServer=function(a){TGS._SERVER_LOCATION=(document.location.protocol==="https:"?"https:":"http:")+"//"+a};TGS.IsOn=function(){return TGS._sOn};TGS.IsReady=function(){if(!TGS._sPartnerID||!TGS._sGameID||!TGS._sPartnerBridge){return false}if(TGS._sPartnerBridge.supportsDatastore()&&(!TGS._sUserID||!TGS.DataStore.GameData)){return false}return TGS._sPartnerBridge.isReady()};TGS.MicrotransactionsSupported=function(){return TGS._sPartnerBridge.supportsMicrotransactions()&&TGS._sPartnerBridge.supportsDatastore()};TGS.MicrotransactionsAllowed=function(){return TGS._sPartnerBridge.allowsMicrotransactions()};TGS.DatastoreSupported=function(){return TGS._sPartnerBridge.supportsDatastore()};TGS.LeaderboardSupported=function(){return TGS._sPartnerBridge.supportsLeaderboard()||TGS._sPartnerBridge.facebookServicesAllowed()};TGS.FacebookServicesSupported=function(){if(!TGS.IsReady()){return false}return TGS._sPartnerBridge.facebookServicesAllowed()&&TGS._sPartnerBridge.isFacebookReady()};TGS.AutoLogin=function(){return TGS._sPartnerBridge.autoLogin()};TGS.LoginIcon=function(){return TGS._sPartnerBridge.loginIcon()};TGS.LogoutIcon=function(){return TGS._sPartnerBridge.logoutIcon()};TGS.ChallengesSupported=function(){return TGS._sPartnerBridge.supportsChallenges()};TGS.Social=function(){};TGS.Social.ChallengeIcon=function(){return TGS._sPartnerBridge.challengeIcon()};TGS.Social.Challenge=function(a){TGS._sPartnerBridge.challenge(a)};TGS.LoggedIn=function(){return TGS._sPartnerBridge.loggedIn()};TGS.LoginUser=function(b){TGS._sLoginOverlay=TGS.LoadingOverlay();var a=new TGS.LoginRequest();a.onSuccess=b.onSuccess;a.onFailure=b.onFailure;a.onUserCancel=b.onUserCancel;TGS._sPartnerBridge.loginUser(a)};TGS.LogoutUser=function(b){TGS._sLoginOverlay=TGS.LoadingOverlay();var a=new TGS.LoginRequest();a.onSuccess=b.onSuccess;a.onFailure=b.onFailure;a.onUserCancel=b.onUserCancel;TGS._sPartnerBridge.logoutUser(a)};TGS.ToggleUserLogin=function(a){if(TGS.AutoLogin()){return}if(TGS.LoggedIn()){TGS.LogoutUser(a)}else{TGS.LoginUser(a)}};TGS._LoginSucceeded=function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user login/logout process was successful");if(a&&a.onSuccess){a.onSuccess.call()}if(TGS._sLoginOverlay){TGS._sLoginOverlay.parentNode.removeChild(TGS._sLoginOverlay);TGS._sLoginOverlay=null}if(window.TGE&&TGE.Game.GetInstance()){TGE.Game.GetInstance().stage.dispatchEvent({type:"tgs_login_changed"})}};TGS._LoginFailed=function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"there was an error during the login/logout process");if(a&&a.onFailure){a.onFailure.call()}if(TGS._sLoginOverlay){TGS._sLoginOverlay.parentNode.removeChild(TGS._sLoginOverlay);TGS._sLoginOverlay=null}};TGS._LoginCanceled=function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user canceled login");if(a.onUserCancel){a.onUserCancel.call()}if(TGS._sLoginOverlay){TGS._sLoginOverlay.parentNode.removeChild(TGS._sLoginOverlay);TGS._sLoginOverlay=null}};TGS.GetDateTime=function(c,a){var b=null;if(!TGS.IsReady()){b="Tried to request the server date/time before TGS was ready"}if(!c){b="Date/time request was made without specifying a success callback"}if(b!==null){if(a){a.call(this,b,null)}else{TGS.Debug.Log(TGS.Debug.LOG_ERROR,b)}return}TGS.Debug.Log(TGS.Debug.LOG_INFO,"requesting date/time from the server...");TGS.SendMessage("time","get",null,TGS._GetDateTimeCallback.bind(this,c),a)};TGS._GetDateTimeCallback=function(b,a){b.call(this,new Date(a.time))};TGS.GameLaunched=function(){if(TGS._sPartnerBridge){TGS._sPartnerBridge.gameWasLaunched()}};TGS.EnablePartnerUI=function(a){if(TGS._sPartnerBridge!==null){TGS._sPartnerBridge.enablePartnerUI(a)}};TGS.GenericSuccessCallback=function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"\tserver request was successful");TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"\tresponse obj: "+JSON.stringify(a))};TGS.GenericErrorCallback=function(b,a){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"\tGenericErrorCallback "+b);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"\tGenericErrorCallback response obj: "+JSON.stringify(a))};TGS.SendMessage=function(h,f,e,d,g){if(!TGS._sOnline){if(g){g("TGS is offline")}return}d=!d?TGS.GenericSuccessCallback:d;g=!g?TGS.GenericErrorCallback:g;var c=TGS._SERVER_LOCATION+h+".php";var b=typeof(f)==="string"?"type="+f+"&":"";var a=b+"data="+e;TGS._DoCORSRequest(c,a,true,d,g)};TGS._DoCORSRequest=function(b,k,h,l,d){var m=null;var a="POST";var j=null;var c=false;try{if(window.XMLHttpRequest){m=new XMLHttpRequest();if("withCredentials" in m){m.open(a,b,true);m.setRequestHeader("Content-type","application/x-www-form-urlencoded");m.send(k)}else{if(typeof XDomainRequest!="undefined"){c=true;m=new XDomainRequest();var f=Math.floor(Math.random()*99999999999);b=b+"?"+k+"&cb="+f;m.open(a,b);m.send()}}}else{m=new ActiveXObject("Microsoft.XMLHTTP");m.open(a,b,true);m.setRequestHeader("Content-type","application/x-www-form-urlencoded");m.send(k)}}catch(g){if(d){d("server failed to respond",g)}}try{if(c){m.timeout=10000;m.onerror=function(){};m.ontimeout=function(){};m.onprogress=function(){};m.onload=function(){try{j=JSON.parse(m.responseText)}catch(o){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"server response could not be parsed: "+m.responseText);j=null}if(j){if(h){if(j.code!==0){if(d){var n="the TGS server returned error code "+j.code;if(typeof(j.message)==="string"){n+=(" "+j.message)}TGS.Debug.Log(TGS.Debug.LOG_WARNING,n);d(n,j);return}}}l(j)}else{if(d){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"server request returned bad data");d("server request returned bad data",null)}}}}else{m.onreadystatechange=function(){if(m.readyState==4){if(m.status!=200){if(d){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"the page returned error code "+m.status+" message: "+m.statusText);d("the page returned error code "+m.status,m)}}else{try{j=JSON.parse(m.responseText)}catch(o){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"server response could not be parsed: "+m.responseText);j=null}if(j){if(h){if(j.code!==0){if(d){var n="the TGS server returned error code "+j.code;if(typeof(j.message)==="string"){n+=(" "+j.message)}TGS.Debug.Log(TGS.Debug.LOG_WARNING,n);d(n,j);return}}}l(j)}else{if(d){TGS.Debug.Log(TGS.Debug.LOG_WARNING,"server request returned bad data");d("server request returned bad data",null)}}}}}}}catch(i){if(d){d("server error",i)}}};TGS.Init=function(b,a){if(typeof(b)!=="string"||b.length<1){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"a valid game id was not specified");return}TGS._sGameID=b;if(typeof(a)!=="string"||a.length<1){TGS.Debug.Log(TGS.Debug.LOG_INFO,"no partner id specified - using generic adapter");TGS._sPartnerID="0000"}else{TGS._sPartnerID=a}TGS._sOn=true;var c="_"+TGS._sPartnerID+"_"+TGS._sGameID;TGS._sLSKeys.TGS_datastore="TGS_datastore"+c;TGS._sLSKeys.TGS_userid="TGS_userid"+c;TGS._sLSKeys.TGS_loggedin_user="TGS_loggedin_user"+c;TGS.Debug.Log(TGS.Debug.LOG_INFO,"initializing TGS for partner "+TGS._sPartnerID);TGS._sPartnerBridge=TGS.PartnerBridge.CreateRequiredAdapter(TGS._sPartnerID);if(TGS._sPartnerBridge===null){TGS.Debug.Log(TGS.Debug.LOG_INFO,"a bridge for this partner could not be created");return}TGS._sPartnerBridge.onAdapterReady=TGS.onPartnerBridgeReady;TGS._sPartnerBridge.onUserInfoAvailable=TGS.onUserInfoAvailable;TGS._sPartnerBridge.masterInitialize();TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"requesting game-partner info from server...");TGS._sPartnerBridge.requestGameInfo(TGS._sGameID)};TGS.onGamePartnerInfoReceived=function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"game-partner info received");TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"game-partner info: "+JSON.stringify(a));if(!a||typeof(a.code)==="undefined"){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"game-partner info was corrupt");return}if(a.code!==0){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"game-partner info contained error code: "+a.code);return}TGS._sGamePartnerInfo=a.partner_values;TGS.Microtransactions._sIAPProducts=a.iap_products;TGS.Microtransactions._sAppURLs=a.app_urls;TGS.Leaderboard._sLeaderboardDescriptors=a.leaderboards;if(TGS._sPartnerBridge.isReady()){TGS.Debug.Log(TGS.Debug.LOG_INFO,"initiating connection to partner...");TGS._sPartnerBridge.masterConnect(TGS._sGamePartnerInfo)}else{TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"partner bridge not ready yet")}};TGS.onGamePartnerInfoError=function(b,a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not retrieve game-partner info: "+b);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"\tresponse obj: "+JSON.stringify(a));if(TGS._sContinueOnPartnerInfoFail){TGS._sGamePartnerInfo={};TGS.Microtransactions._sIAPProducts=[];TGS.Microtransactions._sAppURLs=[];TGS.Leaderboard._sLeaderboardDescriptors=[];TGS._sPartnerBridge.masterConnect(TGS._sGamePartnerInfo)}};TGS.onPartnerBridgeReady=function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"partner bridge is ready");if(TGS._sGamePartnerInfo!==null){TGS.Debug.Log(TGS.Debug.LOG_INFO,"connecting to partner...");TGS._sPartnerBridge.masterConnect(TGS._sGamePartnerInfo)}};TGS.onUserInfoAvailable=function(a){if(!a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"invalid user id");return}TGS._sUserID=a.toString();TGS.Debug.Log(TGS.Debug.LOG_INFO,"user id is: "+TGS._sUserID);TGS.DataStore.ReloadGameData(TGS.onGameDataReceivedForUser)};TGS.onGameDataReceivedForUser=function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"received game info for user "+JSON.stringify(a));TGS.MakeTGSReady()};TGS.MakeTGSReady=function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"MakeTGSReady called");if(TGS.IsReady()){if(window.TGE){var a=TGE.Game.GetInstance();if(a&&a._onTGSReady){a._onTGSReady()}}if(typeof(TGS.onReady)==="function"){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Calling TGS.onReady");TGS.onReady.call(this)}}};TGS.AddRequiredImagesToAssetList=function(b){if(!window.TGE){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"you must be using the TreSensa TGE library to use TGS.AddRequiredImagesToAssetList");return null}var a=TGE.Game.GetInstance();if(TGS.LoginIcon()!==null){a.assetManager.addAsset(b,{id:"tgs_login_icon",url:TGS.LoginIcon(),absolutePath:true})}if(TGS.LogoutIcon()!==null){a.assetManager.addAsset(b,{id:"tgs_logout_icon",url:TGS.LogoutIcon(),absolutePath:true})}if(TGS.Microtransactions.CurrencyIcon()!==null){a.assetManager.addAsset(b,{id:"tgs_currency_icon",url:TGS.Microtransactions.CurrencyIcon(),absolutePath:true})}if(TGS.Social.ChallengeIcon()!==null){a.assetManager.addAsset(b,{id:"tgs_challenge_icon",url:TGS.Social.ChallengeIcon(),absolutePath:true})}};TGS.CreateLoginWidget=function(b){if(!window.TGE){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"you must be using the TreSensa TGE library to use TGS.CreateLoginWidget");return null}var a;if(TGS.AutoLogin()||(!TGS._sPartnerBridge.supportsLogout()&&TGS.LoggedIn())){a=new TGE.DisplayObject()}else{a=new TGE.Button().setup({image:TGS.LoggedIn()?"tgs_logout_icon":"tgs_login_icon",pressFunction:TGS.ToggleUserLogin.bind(null,b)});a.addEventListener("tgs_login_changed",function(d){var c=d.currentTarget;var e=TGS.LoggedIn()?"tgs_logout_icon":"tgs_login_icon";if(!TGS._sPartnerBridge.supportsLogout()&&TGS.LoggedIn()){c.enabled=false;c.visible=false;e=null}c.setImage(e)})}return a};TGS.OverlayMessage=function(y){if(!y||!y.message){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no message specified in TGS.OverlayMessage call");return}var o=TGS.BrowserDetect.onAndroid&&parseInt(TGS.BrowserDetect.OSversion.charAt(0))<4;var w=TGS.BrowserDetect.isMobileDevice?(window.TGE?TGE.Game.GetInstance()._mViewportScale*1.2:0.6):1;var k=1;if(o){k=w;w=1}var l=typeof y.overlayRed==="undefined"?TGS.OverlayRed:y.overlayRed;var B=typeof y.overlayGreen==="undefined"?TGS.OverlayGreen:y.overlayGreen;var x=typeof y.overlayBlue==="undefined"?TGS.OverlayBlue:y.overlayBlue;var v=typeof y.overlayOpacity==="undefined"?TGS.OverlayOpacity:y.overlayOpacity;var c=typeof y.buttonText!=="string"?"OK":y.buttonText;var m=typeof y.buttonAction==="undefined"?null:y.buttonAction;var f=typeof y.buttonSize==="undefined"?1:y.buttonSize;var t=document.createElement("div");t.id="overlay";t.style.zIndex=10;t.style.position="fixed";t.style.width="100%";t.style.height="100%";t.style.top=0;t.style.left=0;t.style.backgroundColor="rgba("+Math.round(l*255).toString()+","+Math.round(B*255).toString()+","+Math.round(x*255).toString()+","+v.toString()+")";if(document.body.firstChild){document.body.insertBefore(t,document.body.firstChild)}else{document.body.appendChild(t)}var s=300*k;var A=0*k;var n=20*k;var g=document.createElement("div");g.id="box";g.style.position="absolute";var h=window.innerWidth/2-((s+n*2+A*2)*w)/2;g.style.left=h.toString()+"px";g.style.width=s+"px";g.style.marginLeft="auto";g.style.marginRight="auto";g.style.textAlign="left";g.style.padding=n+"px";g.style.backgroundColor="#fff";g.style.borderRadius="5px";g.style.boxShadow="0px 0px 20px 4px #222";t.insertBefore(g,t.firstChild);var d=null;var b=null;var r=null;d=document.createElement("img");d.id="close";d.src=TGS._IMAGES_LOCATION+"close-button.png";d.style.position="absolute";d.style.top="-"+n+"px";d.style.left=s+"px";d.style.padding="10px";d.style.cursor="pointer";g.insertBefore(d,g.firstChild);if(c!==""){b=document.createElement("div");b.id="button";b.style.width=Math.round(s*0.4*f*k)+"px";b.style.textAlign="center";b.style.padding=Math.round(10*f)+"px";b.style.backgroundColor="#ef2e24";b.style.color="#fff";b.style.fontSize=Math.round(20*f*k)+"px";b.style.fontWeight="bold";b.innerHTML=c;b.style.cursor="pointer";g.insertBefore(b,g.firstChild)}if(y.button2Image){var q=15;var j=document.createElement("div");j.style.marginLeft="auto";j.style.marginRight="auto";j.style.textAlign="center";j.style.width="100%";j.style.height=(90+q*2)+"px";j.backgroundColor="#f00";g.insertBefore(j,g.firstChild);r=document.createElement("img");r.id="button2";r.src=y.button2Image;r.style.marginLeft="auto";r.style.marginRight="auto";r.style.textAlign="center";r.style.padding=Math.round(q*k)+"px";r.height=Math.round(90*k);r.width=Math.round(256*k);r.style.cursor="pointer";j.insertBefore(r,j.firstChild)}var a=document.createElement("div");a.id="text";a.style.textAlign="left";a.style.color="#000";a.style.fontSize=Math.round(18*k)+"px";a.style.paddingBottom=n+"px";a.innerHTML=y.message;g.insertBefore(a,g.firstChild);if(y.title){var z=document.createElement("div");z.id="title";z.style.textAlign="left";z.style.color="#000";z.style.fontSize=Math.round(26*((1+k)/2))+"px";z.style.fontWeight="bold";z.style.paddingBottom="10px";z.innerHTML=y.title;g.insertBefore(z,g.firstChild)}var p=Math.min(window.innerHeight,(window.GameConfig&&GameConfig.ORIENTATION==="landscape"?536:832))/2-(g.clientHeight*w)/2;g.style.top=p.toString()+"px";var i=function(){t.parentNode.removeChild(t);if(m){m.call()}};var e=!TGS.BrowserDetect.isMobileDevice||TGS.BrowserDetect.platform==="Windows Phone"?"click":"touchstart";if(b!==null){b.addEventListener(e,i,false)}if(d!==null){d.addEventListener(e,i,false)}if(r!==null){r.addEventListener(e,y.button2Callback,false)}t.addEventListener("click",TGS._BlockEvent,false);t.addEventListener("mousedown",TGS._BlockEvent,false);t.addEventListener("mouseup",TGS._BlockEvent,false);t.addEventListener("mousemove",TGS._BlockEvent,false);t.addEventListener("touchstart",TGS._BlockEvent,false);if(!o){var u=g.getAttribute("style")||"";g.setAttribute("style",u+" -ms-transform-origin: 0% 0%; -webkit-transform-origin: 0% 0%; -moz-transform-origin: 0% 0%; -o-transform-origin: 0% 0%; transform-origin: 0% 0%; -ms-transform: scale("+w+"); -webkit-transform: scale("+w+"); -moz-transform: scale("+w+"); -o-transform: scale("+w+"); transform: scale("+w+");")}};TGS.LoadingOverlay=function(){var c=TGS.OverlayRed;var b=TGS.OverlayGreen;var g=TGS.OverlayBlue;var e=TGS.OverlayOpacity;var d=document.createElement("div");d.id="overlay";d.style.zIndex=10;d.style.position="fixed";d.style.width="100%";d.style.height="100%";d.style.top=0;d.style.left=0;d.style.backgroundColor="rgba("+Math.round(c*255).toString()+","+Math.round(b*255).toString()+","+Math.round(g*255).toString()+","+e.toString()+")";if(document.body.firstChild){document.body.insertBefore(d,document.body.firstChild)}else{document.body.appendChild(d)}var a=document.createElement("img");a.id="gif";a.src=TGS._IMAGES_LOCATION+"processing.gif";var f=window.innerHeight*0.45;a.style.display="block";a.style.marginLeft="auto";a.style.marginRight="auto";a.style.marginTop=f.toString()+"px";a.style.align="center";d.insertBefore(a,d.firstChild);d.addEventListener("click",TGE._BlockEvent,false);d.addEventListener("mousedown",TGE._BlockEvent,false);d.addEventListener("mouseup",TGE._BlockEvent,false);d.addEventListener("mousemove",TGE._BlockEvent,false);d.addEventListener("touchstart",TGE._BlockEvent,false);return d};TGS._BlockEvent=function(a){a.stopPropagation();a.preventDefault();if(a.stopImmediatePropagation){a.stopImmediatePropagation()}return false};TGS.LoginRequest=function(){this.onSuccess=null;this.onFailure=null;this.onUserCancel=null};